<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>UAV-AI Assistant</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
      <link rel="stylesheet" href="/static/css/style.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
   </head>
   <body>
      <!-- Header -->
      <header>
         <div class="logo">UAV-AI Assistant</div>
         <div class="connection-status">
            <span id="connectionText">Disconnected</span>
            <div class="status-indicator" id="connectionIndicator"></div>
            <span id="headerParamsText" class="header-stat" style="display: none;">Params: <span id="headerParamsValue" class="telemetry-value">0%</span></span>
            <span id="headerLatencyText" class="header-stat" style="display: none;">Latency: <span id="headerLatencyValue" class="telemetry-value">0ms</span></span>
            <div id="copilotBadge" class="copilot-badge" style="display:none;" title="Click to toggle co-pilot mode. Shift+click for auto mode.">
               <i class="fas fa-robot"></i> CO-PILOT
            </div>
            <button class="panel-toggle-btn" id="toggleSidebar" title="Toggle sidebar">
               <i class="fas fa-bars"></i>
            </button>
            <button class="panel-toggle-btn" id="toggleChat" title="Toggle chat panel">
               <i class="fas fa-comment"></i>
            </button>
         </div>
      </header>
      <!-- Main Container -->
      <div class="container">
         <!-- Sidebar -->
         <div class="sidebar">
            <div class="drone-selector" id="connectButton">
               <span>Connect Drone</span>
               <i class="fas fa-chevron-down"></i>
            </div>
            <div class="drone-selector" id="disconnectButton" style="display: none; background-color: var(--danger-color); cursor: pointer;">
               <span>Disconnect Drone</span>
               <i class="fas fa-times"></i>
            </div>

            <!-- ── Status ── -->
            <div class="nav-group-label">Status</div>
            <div class="menu-item active" data-tab="dashboard">
               <i class="fas fa-tachometer-alt"></i>
               Dashboard
            </div>
            <div class="menu-item" data-tab="drone-view">
               <i class="fas fa-plane"></i>
               Drone View
            </div>

            <!-- ── Configure ── -->
            <div class="nav-group-label">Configure</div>
            <div class="menu-item" data-tab="parameters">
               <i class="fas fa-sliders-h"></i>
               Tuning
            </div>
            <div class="menu-item" data-tab="receiver">
               <i class="fas fa-broadcast-tower"></i>
               RC &amp; Modes
            </div>
            <div class="menu-item" data-tab="serial-ports">
               <i class="fas fa-plug"></i>
               Serial Ports
            </div>
            <div class="menu-item" data-tab="configs">
               <i class="fas fa-save"></i>
               Configs
            </div>

            <!-- ── Maintenance ── -->
            <div class="nav-group-label">Maintenance</div>
            <div class="menu-item" data-tab="calibration">
               <i class="fas fa-crosshairs"></i>
               Calibration
            </div>
            <div class="menu-item" data-tab="motors">
               <i class="fas fa-cog"></i>
               Motors
            </div>
            <div class="menu-item" data-tab="firmware">
               <i class="fas fa-microchip"></i>
               Firmware
            </div>

            <!-- ── Analysis ── -->
            <div class="nav-group-label">Analysis</div>
            <div class="menu-item" data-tab="logs">
               <i class="fas fa-file-alt"></i>
               Logs
            </div>
            <div class="menu-item" data-tab="latency-params">
               <i class="fas fa-chart-line"></i>
               Latency
            </div>

            <div class="nav-spacer"></div>
            <div class="menu-item" data-tab="settings">
               <i class="fas fa-cog"></i>
               Settings
            </div>
         </div>
         <!-- Main Content -->
         <div class="main-content">
            <!-- Dashboard -->
            <div class="dashboard tab-content active" id="dashboard-tab">
               <h2 class="dashboard-title">System Overview</h2>
               <!-- Top Cards -->
               <div class="cards-row">
                  <div class="card">
                     <div class="card-title">SYSTEM HEALTH</div>
                     <div class="system-health">
                        <div class="health-score">
                           <svg viewBox="0 0 36 36">
                              <path d="M18 2.0845
                                 a 15.9155 15.9155 0 0 1 0 31.831
                                 a 15.9155 15.9155 0 0 1 0 -31.831"
                                 fill="none"
                                 stroke="#e0e0e0"
                                 stroke-width="3"
                                 stroke-dasharray="100, 100"/>
                              <path id="healthScoreArc" d="M18 2.0845
                                 a 15.9155 15.9155 0 0 1 0 31.831
                                 a 15.9155 15.9155 0 0 1 0 -31.831"
                                 fill="none"
                                 stroke="#e74c3c"
                                 stroke-width="3"
                                 stroke-dasharray="68, 100"/>
                           </svg>
                           <div class="health-score-text" id="healthScoreText">--</div>
                        </div>
                        <div class="health-issues" id="healthIssues">-- CRITICAL ISSUES</div>
                     </div>
                  </div>
                  <div class="card">
                     <div class="card-title">FLIGHT READINESS</div>
                     <div class="flight-readiness">
                        <div class="readiness-indicator" id="readinessIndicator">--</div>
                        <div class="readiness-message" id="readinessMessage">--</div>
                     </div>
                  </div>
               </div>
               <!-- Status Cards -->
               <div class="cards-row">
                  <div class="card">
                     <div class="card-title">BATTERY STATUS</div>
                     <div class="status-text" id="batteryText">-- / -- Threshold</div>
                     <div class="status-bar">
                        <div class="status-indicator-bar" id="batteryIndicator"></div>
                     </div>
                     <div class="critical-text" id="batteryStatus">--</div>
                  </div>
                  <div class="card">
                     <div class="card-title">GPS STATUS</div>
                     <div class="status-text" id="gpsText">Fix Type: -- (No Fix)</div>
                     <div class="status-bar">
                        <div class="status-indicator-bar" id="gpsIndicator"></div>
                     </div>
                     <div class="critical-text" id="gpsSatellites">-- SATELLITES VISIBLE</div>
                  </div>
               </div>
               <!-- Motors Status Card -->
               <div class="card">
                  <div class="card-title">MOTORS STATUS</div>
                  <div class="motors-grid">
                     <div class="motor-card">
                        <div class="motor-title">Motor 1</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor1Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor1Status">--</div>
                     </div>
                     <div class="motor-card">
                        <div class="motor-title">Motor 2</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor2Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor2Status">--</div>
                     </div>
                     <div class="motor-card">
                        <div class="motor-title">Motor 3</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor3Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor3Status">--</div>
                     </div>
                     <div class="motor-card">
                        <div class="motor-title">Motor 4</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor4Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor4Status">--</div>
                     </div>
                  </div>
               </div>
               <!-- Subsystem Status Table -->
               <!-- First-Run Tour Card -->
               <div class="card first-run-card" id="firstRunCard" style="display: none;">
                  <div class="card-title">Welcome to UAV-AI</div>
                  <p class="hint-text">
                     New here? Follow these three steps to see UAV-AI in action.
                  </p>
                  <ol class="u-text-sm u-mb-2 first-run-list">
                     <li class="u-mb-1">
                        <strong>Connect your drone:</strong>
                        Click <em>Connect Drone</em> in the left sidebar and choose Serial or UDP.
                     </li>
                     <li class="u-mb-1">
                        <strong>Test Co-pilot:</strong>
                        In the chat, type <code>gps status</code> to get an instant answer (no cloud).
                     </li>
                     <li>
                        <strong>Ask JARVIS:</strong>
                        Once connected, ask <code>why is my compass off?</code> for a full AI diagnosis.
                     </li>
                  </ol>
                  <button id="dismissFirstRun" class="action-button u-mt-2">
                     Got it, hide this
                  </button>
               </div>
               <!-- Pre-flight Readiness -->
               <div class="card preflight-panel" id="preflightPanel">
                  <div class="preflight-header">
                     <span class="card-title u-mb-0">PRE-FLIGHT READINESS</span>
                     <span class="preflight-badge" id="preflightBadge">--</span>
                  </div>
                  <div class="preflight-checks" id="preflightChecks"></div>
               </div>

               <div class="card">
                  <div class="card-title">SUBSYSTEM STATUS</div>
                  <table class="subsystem-table" id="subsystemTable">
                     <thead>
                        <tr>
                           <th>COMPONENT</th>
                           <th>STATUS</th>
                           <th>DETAILS</th>
                        </tr>
                     </thead>
                     <tbody>
                     </tbody>
                  </table>
               </div>
               <!-- Hardware Inventory Card -->
               <div class="card">
                  <div class="card-title">HARDWARE INVENTORY</div>

                  <!-- Firmware row -->
                  <div class="hw-firmware-row">
                     <span class="hw-fw-label">Firmware</span>
                     <span id="firmwareVersion" class="hw-fw-value">--</span>
                     <span id="hwFwBadge" class="badge badge-info" style="display:none;"></span>
                  </div>

                  <!-- Sensor grid: IMU / Baro / Compass / GPS -->
                  <div class="hw-sensor-grid">
                     <div class="hw-sensor-cell">
                        <div class="hw-sensor-icon"><i class="fas fa-microchip"></i></div>
                        <div class="hw-sensor-label">IMU</div>
                        <div class="hw-sensor-value" id="hwImu">--</div>
                     </div>
                     <div class="hw-sensor-cell">
                        <div class="hw-sensor-icon"><i class="fas fa-tachometer-alt"></i></div>
                        <div class="hw-sensor-label">Barometer</div>
                        <div class="hw-sensor-value" id="hwBaro">--</div>
                     </div>
                     <div class="hw-sensor-cell">
                        <div class="hw-sensor-icon"><i class="fas fa-compass"></i></div>
                        <div class="hw-sensor-label">Compass</div>
                        <div class="hw-sensor-value" id="hwCompass">--</div>
                     </div>
                     <div class="hw-sensor-cell">
                        <div class="hw-sensor-icon"><i class="fas fa-satellite"></i></div>
                        <div class="hw-sensor-label">GPS</div>
                        <div class="hw-sensor-value" id="hwGps">--</div>
                     </div>
                  </div>

                  <!-- ESC + system stats row -->
                  <div class="hw-stats-row">
                     <div class="hw-stat-item">
                        <span class="hw-stat-label">ESC Protocol</span>
                        <span class="hw-stat-value" id="hwEsc">--</span>
                     </div>
                     <div class="hw-stat-item">
                        <span class="hw-stat-label">CPU Load</span>
                        <div class="hw-stat-bar-wrap">
                           <div class="hw-stat-bar" id="hwCpuBar"></div>
                        </div>
                        <span class="hw-stat-value" id="hwCpuLoad">--%</span>
                     </div>
                     <div class="hw-stat-item">
                        <span class="hw-stat-label">Free RAM</span>
                        <span class="hw-stat-value" id="hwFreeRam">-- KB</span>
                     </div>
                     <div class="hw-stat-item">
                        <span class="hw-stat-label">Msg Drop Rate</span>
                        <span class="hw-stat-value" id="hwDropRate">--%</span>
                     </div>
                     <div class="hw-stat-item">
                        <span class="hw-stat-label">Flash Storage</span>
                        <span class="hw-stat-value" id="hwFlash">-- MB</span>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Serial Ports Tab -->
            <div class="tab-content tab-panel" id="serial-ports-tab" style="display: none;">
               <h2 class="dashboard-title">Serial Port Configuration</h2>
               <div class="card">
                  <div class="card-title">UART ASSIGNMENT</div>
                  <p class="hint-text">Assign peripherals to serial ports. Changes require Save &amp; Reboot.</p>
                  <div class="scroll-x">
                     <table class="serial-port-table" id="serialPortTable">
                        <thead>
                           <tr>
                              <th>Port</th>
                              <th>Label</th>
                              <th>Protocol</th>
                              <th>Baud Rate</th>
                           </tr>
                        </thead>
                        <tbody id="serialPortBody"></tbody>
                     </table>
                  </div>
                  <div class="flex-row u-mt-2 u-justify-end">
                     <button class="btn btn-ghost" id="serialRefreshBtn">Refresh</button>
                     <button class="btn btn-ghost" id="serialPreviewBtn">Preview</button>
                     <button class="btn btn-primary" id="serialSaveBtn">Save &amp; Reboot</button>
                  </div>
                  <div id="serialStatus" class="hint-text u-mt-1"></div>
               </div>
            </div>
            <!-- Firmware Tab -->
            <div class="tab-content tab-panel" id="firmware-tab" style="display: none;">
               <h2 class="dashboard-title">Firmware</h2>
               <p class="hint-text">Flash ArduPilot firmware from a local file or the online firmware server.</p>

               <!-- Current Firmware Info -->
               <div class="card u-mb-2">
                  <div class="card-title"><i class="fas fa-info-circle"></i> Current Firmware</div>
                  <div id="fwCurrentInfo" class="hint-text u-mb-0">
                     Not connected — connect a flight controller to see firmware info.
                  </div>
               </div>

               <!-- Flash Method Tabs -->
               <div class="flex-row u-mb-2">
                  <button id="fwMethodSerial" class="fw-method-btn fw-method-active" onclick="window._fwTab && window._fwTab.setMethod('serial')">
                     <i class="fas fa-plug"></i> Serial (.apj)
                  </button>
                  <button id="fwMethodDfu" class="fw-method-btn" onclick="window._fwTab && window._fwTab.setMethod('dfu')">
                     <i class="fas fa-microchip"></i> DFU (.bin)
                  </button>
               </div>

               <!-- Serial Flash Panel -->
               <div id="fwSerialPanel">
                  <div class="card u-mb-2">
                     <div class="card-title"><i class="fas fa-file-upload"></i> Flash Local File</div>
                     <p class="hint-text">Select an ArduPilot <code>.apj</code> firmware file from your computer.</p>
                     <div class="flex-row flex-wrap">
                        <input type="file" id="fwLocalFile" accept=".apj" class="u-text-sm">
                        <button id="fwFlashLocalBtn" class="btn btn-primary" disabled>
                           <i class="fas fa-bolt"></i> Flash Selected File
                        </button>
                     </div>
                     <div id="fwLocalStatus" class="hint-text u-mt-1 u-mb-0"></div>
                  </div>
               </div>

               <!-- DFU Flash Panel -->
               <div id="fwDfuPanel" style="display:none;">

                  <!-- Step 1: Enter DFU -->
                  <div class="card u-mb-2">
                     <div class="card-title"><i class="fas fa-microchip"></i> Step 1 — Enter DFU Mode</div>
                     <p class="hint-text">Click the button to enter DFU mode automatically. If that fails, hold the <strong>BOOT</strong> button on the FC and replug the USB cable.</p>
                     <div class="flex-row flex-wrap">
                        <button id="dfuEnterBtn" class="btn btn-primary">
                           <i class="fas fa-sign-in-alt"></i> Enter DFU Mode
                        </button>
                        <button id="dfuDetectBtn" class="btn btn-ghost">
                           <i class="fas fa-search"></i> Detect Board
                        </button>
                        <span id="dfuStatusChip" class="dfu-chip">Not detected</span>
                     </div>
                  </div>

                  <!-- Board info panel (shown after detection) -->
                  <div class="card u-mb-2" id="dfuBoardCard" style="display: none;">
                     <div class="card-title"><i class="fas fa-circuit-board"></i> Detected Board</div>
                     <table class="data-table">
                        <tr><td class="u-semibold" style="width:140px;">Manufacturer</td><td id="dfuBoardMfr">--</td></tr>
                        <tr><td class="u-semibold">Model</td><td id="dfuBoardModel">--</td></tr>
                        <tr><td class="u-semibold">USB ID</td><td id="dfuBoardUsb">--</td></tr>
                        <tr><td class="u-semibold">USB Descriptor</td><td id="dfuBoardDesc">--</td></tr>
                     </table>
                  </div>

                  <!-- Step 2: Select firmware -->
                  <div class="card u-mb-2">
                     <div class="card-title"><i class="fas fa-file-code"></i> Step 2 — Select Firmware (.bin)</div>
                     <p class="hint-text">Upload a local <code>.bin</code> file, or use the Online Firmware list below (select a firmware and click <strong>DFU Flash</strong>).</p>
                     <div class="flex-row flex-wrap">
                        <input type="file" id="dfuLocalFile" accept=".bin" class="u-text-sm">
                        <button id="dfuFlashLocalBtn" class="btn btn-danger" disabled>
                           <i class="fas fa-bolt"></i> DFU Flash Selected File
                        </button>
                     </div>
                  </div>

               </div>

               <!-- Online Firmware (shared by both Serial and DFU) -->
               <div class="card u-mb-2">
                  <div class="card-title"><i class="fas fa-cloud-download-alt"></i> Online Firmware</div>
                  <div class="flex-row flex-wrap u-mb-2">
                     <select id="fwVehicleFilter" class="form-control" style="width:auto;">
                        <option value="">All Vehicle Types</option>
                        <option value="Copter">Copter</option>
                        <option value="Plane">Plane</option>
                        <option value="Rover">Rover</option>
                        <option value="Sub">Sub</option>
                        <option value="Tracker">Tracker</option>
                        <option value="Heli">Heli</option>
                     </select>
                     <button id="fwRefreshManifest" class="btn btn-ghost btn-sm">
                        <i class="fas fa-sync-alt"></i> Refresh
                     </button>
                  </div>
                  <div id="fwOnlineList" class="u-text-sm" style="max-height: 300px; overflow-y: auto;">
                     <p class="u-text-secondary">Click Refresh to fetch available firmware.</p>
                  </div>
               </div>

               <!-- Flash Progress -->
               <div class="card u-mb-2" id="fwProgressCard" style="display: none;">
                  <div class="card-title"><i class="fas fa-tasks"></i> Flash Progress</div>
                  <div id="fwProgressStage" class="u-semibold u-mb-1">Idle</div>
                  <div class="progress-track u-mb-1">
                     <div id="fwProgressBar" class="progress-fill" style="width:0%;"></div>
                  </div>
                  <div id="fwProgressLog" class="fw-log"></div>
               </div>
            </div>

            <!-- Tuning Tab (was Parameters) -->
            <div class="tab-content tab-panel" id="parameters-tab" style="display: none;">

               <!-- Sub-tab bar -->
               <div class="subtab-bar">
                  <button class="subtab-btn active" data-subtab="tuning-parameters">
                     <i class="fas fa-list"></i> Parameters
                  </button>
                  <button class="subtab-btn" data-subtab="tuning-filter-viz">
                     <i class="fas fa-bezier-curve"></i> Filter Visualizer
                  </button>
                  <button class="subtab-btn" data-subtab="tuning-step-predictor">
                     <i class="fas fa-chart-area"></i> Step Predictor
                  </button>
               </div>

               <!-- Sub-tab: Parameters (existing table, unchanged) -->
               <div class="subtab-panel" id="tuning-parameters">
                  <div class="flex-between u-mb-2">
                     <div class="flex-row">
                        <input type="text" id="paramSearch" placeholder="Search parameters..." class="form-control" style="width:220px;">
                        <button id="searchBtn" class="btn btn-primary btn-icon">
                           <i class="fas fa-search"></i>
                        </button>
                     </div>
                     <div class="flex-row">
                        <select id="categoryFilter" class="form-control" style="width:auto;">
                           <option value="All Categories">All Categories</option>
                           <option value="System">System</option>
                           <option value="GPS">GPS</option>
                           <option value="Battery">Battery</option>
                           <option value="Serial">Serial</option>
                           <option value="Compass">Compass</option>
                           <option value="IMU">IMU</option>
                           <option value="Navigation">Navigation</option>
                           <option value="Motors">Motors</option>
                           <option value="Servos">Servos</option>
                           <option value="RC">RC</option>
                           <option value="Flight Modes">Flight Modes</option>
                           <option value="Safety">Safety</option>
                           <option value="EKF">EKF</option>
                           <option value="AHRS">AHRS</option>
                           <option value="Control">Control</option>
                           <option value="Pilot">Pilot</option>
                           <option value="Landing">Landing</option>
                           <option value="Barometer">Barometer</option>
                           <option value="RangeFinder">RangeFinder</option>
                           <option value="RPM">RPM</option>
                           <option value="Notifications">Notifications</option>
                           <option value="OSD">OSD</option>
                           <option value="Logging">Logging</option>
                           <option value="Scheduler">Scheduler</option>
                           <option value="Streaming">Streaming</option>
                           <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                        <button id="refreshParams" class="btn btn-ghost btn-sm">
                           <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="saveParams" class="btn btn-success btn-sm">
                           <i class="fas fa-save"></i> Save Changes
                        </button>
                     </div>
                  </div>
                  <div class="scroll-x">
                     <table id="parametersTable" class="data-table">
                        <thead>
                           <tr>
                              <th>Name</th>
                              <th>Value</th>
                              <th>Description</th>
                              <th>Range</th>
                              <th>Actions</th>
                           </tr>
                        </thead>
                        <tbody id="parametersTableBody"></tbody>
                     </table>
                  </div>
               </div>

               <!-- Sub-tab: Filter Visualizer -->
               <div class="subtab-panel" id="tuning-filter-viz" style="display:none;">

                  <!-- No connection placeholder -->
                  <div id="filterVizNoConn" class="log-analyst-placeholder">
                     <i class="fas fa-plug"></i>
                     <p>Connect to a flight controller to visualize the filter stack.</p>
                  </div>

                  <!-- Chart panel (shown when params available) -->
                  <div id="filterVizPanel" style="display:none;">
                     <!-- Series toggles + Ask JARVIS -->
                     <div class="filter-viz-controls">
                        <span class="filter-ctrl-label">Series:</span>
                        <label class="filter-series-toggle"><input type="checkbox" data-series="0" checked> <span style="color:#3498db;">Gyro LPF</span></label>
                        <label class="filter-series-toggle"><input type="checkbox" data-series="1" checked> <span style="color:#e74c3c;">Static Notch</span></label>
                        <label class="filter-series-toggle"><input type="checkbox" data-series="2" checked> <span style="color:#f39c12;">Harm. Notch</span></label>
                        <label class="filter-series-toggle"><input type="checkbox" data-series="3" checked> <span style="color:#9b59b6;">D-term LPF</span></label>
                        <label class="filter-series-toggle"><input type="checkbox" data-series="4" checked> <span style="color:#2ecc71;">Total</span></label>
                        <button id="filterVizAskJarvis" class="btn btn-secondary" style="margin-left:auto;">
                           <i class="fas fa-robot"></i> Ask JARVIS
                        </button>
                     </div>
                     <!-- Active filter params summary -->
                     <div id="filterParamsSummary" class="filter-params-summary"></div>
                     <!-- Bode plot canvas -->
                     <div class="spectrum-chart-wrap">
                        <canvas id="filterVizCanvas"></canvas>
                     </div>
                  </div>

               </div>

               <!-- Sub-tab: Step Predictor -->
               <div class="subtab-panel" id="tuning-step-predictor" style="display:none;">

                  <!-- No connection placeholder -->
                  <div id="stepPredNoConn" class="log-analyst-placeholder">
                     <i class="fas fa-plug"></i>
                     <p>Connect to a flight controller to use the Step Predictor.</p>
                  </div>

                  <div id="stepPredPanel" style="display:none;">

                     <!-- Mode toggle -->
                     <div class="step-mode-bar">
                        <button class="step-mode-btn active" id="stepModeFeelBtn">
                           <i class="fas fa-hand-paper"></i> Flight Feel
                        </button>
                        <button class="step-mode-btn" id="stepModeExpertBtn">
                           <i class="fas fa-sliders-h"></i> Expert (P/I/D)
                        </button>
                        <div style="margin-left:auto; display:flex; gap:0.5rem;">
                           <button id="stepApplyBtn" class="btn btn-success btn-sm">
                              <i class="fas fa-upload"></i> Apply to FC
                           </button>
                           <button id="stepResetBtn" class="btn btn-ghost btn-sm">
                              <i class="fas fa-undo"></i> Reset
                           </button>
                           <button id="stepAskJarvisBtn" class="btn btn-secondary btn-sm">
                              <i class="fas fa-robot"></i> Ask JARVIS
                           </button>
                        </div>
                     </div>

                     <!-- Flight Feel mode -->
                     <div id="stepFeelMode" class="step-feel-grid">
                        <div class="step-feel-row">
                           <span class="step-feel-label">Aggressiveness</span>
                           <input type="range" class="step-feel-slider" id="feelAggressive" min="20" max="150" value="100">
                           <span class="step-feel-val" id="feelAggressiveVal">1.0×</span>
                           <span class="step-feel-hint">Roll/Pitch P gain</span>
                        </div>
                        <div class="step-feel-row">
                           <span class="step-feel-label">Smoothness</span>
                           <input type="range" class="step-feel-slider" id="feelSmooth" min="20" max="150" value="100">
                           <span class="step-feel-val" id="feelSmoothVal">1.0×</span>
                           <span class="step-feel-hint">D-term gain</span>
                        </div>
                        <div class="step-feel-row">
                           <span class="step-feel-label">Position Hold</span>
                           <input type="range" class="step-feel-slider" id="feelPosHold" min="30" max="200" value="100">
                           <span class="step-feel-val" id="feelPosHoldVal">1.0×</span>
                           <span class="step-feel-hint">PSC_POSXY_P</span>
                        </div>
                        <div class="step-feel-row">
                           <span class="step-feel-label">Stick Feel</span>
                           <input type="range" class="step-feel-slider" id="feelStick" min="0" max="100" value="50">
                           <span class="step-feel-val" id="feelStickVal">50</span>
                           <span class="step-feel-hint">RC_FEEL_RP</span>
                        </div>
                     </div>

                     <!-- Expert P/I/D mode -->
                     <div id="stepExpertMode" class="step-expert-grid" style="display:none;">
                        <div class="step-expert-header"><span>Gain</span><span>Roll</span><span>Pitch</span><span>Yaw</span></div>
                        <div class="step-expert-row">
                           <span>P</span>
                           <input type="number" class="step-expert-input" id="expRollP" step="0.01" min="0">
                           <input type="number" class="step-expert-input" id="expPitchP" step="0.01" min="0">
                           <input type="number" class="step-expert-input" id="expYawP" step="0.01" min="0">
                        </div>
                        <div class="step-expert-row">
                           <span>I</span>
                           <input type="number" class="step-expert-input" id="expRollI" step="0.01" min="0">
                           <input type="number" class="step-expert-input" id="expPitchI" step="0.01" min="0">
                           <input type="number" class="step-expert-input" id="expYawI" step="0.01" min="0">
                        </div>
                        <div class="step-expert-row">
                           <span>D</span>
                           <input type="number" class="step-expert-input" id="expRollD" step="0.001" min="0">
                           <input type="number" class="step-expert-input" id="expPitchD" step="0.001" min="0">
                           <input type="number" class="step-expert-input" id="expYawD" step="0.001" min="0">
                        </div>
                     </div>

                     <!-- Axis selector + predicted response chart -->
                     <div class="step-chart-header">
                        <span class="filter-ctrl-label">Predicted Step Response — Axis:</span>
                        <button class="spectrum-axis-btn active" data-stepaxis="roll">Roll</button>
                        <button class="spectrum-axis-btn" data-stepaxis="pitch">Pitch</button>
                        <button class="spectrum-axis-btn" data-stepaxis="yaw">Yaw</button>
                     </div>
                     <div class="step-param-summary" id="stepParamSummary"></div>
                     <div class="spectrum-chart-wrap">
                        <canvas id="stepPredCanvas"></canvas>
                     </div>

                  </div>
               </div>

            </div>
            <!-- Logs Tab -->
            <div class="tab-content tab-panel tab-panel-dark" id="logs-tab" style="display: none;">

               <!-- Sub-tab bar -->
               <div class="subtab-bar">
                  <button class="subtab-btn active" data-subtab="logs-timeline">
                     <i class="fas fa-chart-line"></i> Timeline
                  </button>
                  <button class="subtab-btn" data-subtab="logs-spectrum">
                     <i class="fas fa-wave-square"></i> Spectrum (FFT)
                  </button>
                  <button class="subtab-btn" data-subtab="logs-ai-analyst">
                     <i class="fas fa-robot"></i> AI Analyst
                  </button>
               </div>

               <!-- Sub-tab: Timeline (existing content unchanged) -->
               <div class="subtab-panel" id="logs-timeline">
                  <div class="flex-row flex-wrap flex-gap-2 u-mb-2 u-items-start">
                     <div class="log-upload-area" id="logUploadArea">
                        <i class="fas fa-cloud-upload-alt u-text-lg u-text-accent"></i>
                        <p class="u-semibold u-mt-1">Upload Log File</p>
                        <p class="u-text-xs u-text-secondary">Drag &amp; drop .bin or .tlog, or click to browse</p>
                        <input type="file" id="logFileInput" accept=".bin,.tlog" style="display:none;">
                     </div>
                     <div class="flex-col">
                        <button id="fetchLogsButton" class="btn btn-primary">
                           <i class="fas fa-download"></i> Fetch FC Logs
                        </button>
                        <div id="logContent" class="hint-text u-mb-0"></div>
                     </div>
                  </div>
                  <div class="log-status-bar" id="logStatusBar" style="display:none;">
                     <span id="logStatusText"></span>
                  </div>
                  <div class="log-viz-area" id="logVizArea"></div>
               </div>

               <!-- Sub-tab: Spectrum (FFT) -->
               <div class="subtab-panel" id="logs-spectrum" style="display:none;">

                  <!-- No log placeholder -->
                  <div id="spectrumNoLog" class="log-analyst-placeholder">
                     <i class="fas fa-wave-square"></i>
                     <p>Upload a flight log in the <strong>Timeline</strong> tab to view the noise spectrum.</p>
                  </div>

                  <!-- Controls + chart (shown when log loaded) -->
                  <div id="spectrumPanel" style="display:none;">
                     <div class="spectrum-controls">
                        <div class="spectrum-ctrl-group">
                           <span class="spectrum-ctrl-label">Axis</span>
                           <button class="spectrum-axis-btn active" data-axis="roll">Roll</button>
                           <button class="spectrum-axis-btn" data-axis="pitch">Pitch</button>
                           <button class="spectrum-axis-btn" data-axis="yaw">Yaw</button>
                        </div>
                        <div class="spectrum-ctrl-group">
                           <span class="spectrum-ctrl-label">Source</span>
                           <button class="spectrum-src-btn active" data-src="imu">Raw Gyro (IMU)</button>
                           <button class="spectrum-src-btn" data-src="rate">PID Rate (RATE)</button>
                        </div>
                        <button id="spectrumAskJarvis" class="btn btn-secondary" style="margin-left:auto;">
                           <i class="fas fa-robot"></i> Ask JARVIS
                        </button>
                     </div>
                     <div class="spectrum-peaks" id="spectrumPeaks"></div>
                     <div class="spectrum-chart-wrap">
                        <canvas id="spectrumCanvas"></canvas>
                     </div>
                  </div>

               </div>

               <!-- Sub-tab: AI Analyst -->
               <div class="subtab-panel" id="logs-ai-analyst" style="display:none;">

                  <!-- Flight summary chips (shown after log upload) -->
                  <div id="logSummaryChips" class="log-summary-chips" style="display:none;"></div>

                  <!-- Placeholder when no log is loaded -->
                  <div id="logAnalystNoLog" class="log-analyst-placeholder">
                     <i class="fas fa-file-alt"></i>
                     <p>Upload a flight log in the <strong>Timeline</strong> tab to analyse it here.</p>
                  </div>

                  <!-- Chat panel (shown when log is loaded) -->
                  <div id="logAnalystPanel" class="log-analyst-panel" style="display:none;">
                     <div id="logAnalystMessages" class="log-analyst-messages"></div>
                     <div class="log-analyst-input-row">
                        <input type="text" id="logAnalystInput" class="log-analyst-input"
                               placeholder="Ask about this flight — vibration, battery, GPS, modes...">
                        <button id="logAnalystSend" class="btn btn-primary">
                           <i class="fas fa-paper-plane"></i>
                        </button>
                     </div>
                  </div>

               </div>

            </div>
            <!-- Latency & Parameters Tab -->
            <div class="tab-content tab-panel" id="latency-params-tab" style="display: none;">
               <h2 class="dashboard-title">Latency & Parameters</h2>
               <div class="card">
                  <div class="card-title">LATENCY MONITOR</div>
                  <div class="flex-between u-mb-2">
                     <div class="stat-block">
                        <div class="stat-value" id="currentLatency">-- ms</div>
                        <div class="stat-label">Current Latency</div>
                     </div>
                     <div class="stat-block">
                        <div class="stat-value-sm telemetry-value" id="avgLatency">-- ms</div>
                        <div class="stat-label">Average</div>
                     </div>
                     <div class="stat-block">
                        <div class="stat-value-sm telemetry-value" id="maxLatency">-- ms</div>
                        <div class="stat-label">Maximum</div>
                     </div>
                     <div class="stat-block">
                        <div class="stat-value-sm telemetry-value" id="minLatency">-- ms</div>
                        <div class="stat-label">Minimum</div>
                     </div>
                  </div>
                  <div class="chart-container u-mb-2">
                     <canvas id="latencyChart" width="100%" height="100%"></canvas>
                     <div id="noLatencyData" class="hint-text chart-empty-state" style="display:none;">No latency data available</div>
                  </div>
                  <div class="flex-row">
                     <div class="status-dot" id="latencyStatusIndicator"></div>
                     <div id="latencyStatusText" class="u-text-sm">Latency Status: Unknown</div>
                  </div>
               </div>
               <div class="card u-mt-2">
                  <div class="card-title">MAVLINK LINK STATS</div>
                  <div class="flex-between">
                     <div class="stat-block">
                        <div class="stat-value" id="linkPktRate">-- pkt/s</div>
                        <div class="stat-label">Incoming Packet Rate</div>
                     </div>
                     <div class="stat-block">
                        <div class="stat-value-sm telemetry-value" id="linkByteRate">-- B/s</div>
                        <div class="stat-label">Link Speed</div>
                     </div>
                  </div>
               </div>
               <div class="card u-mt-2">
                  <div class="card-title">PARAMETERS DOWNLOAD PROGRESS</div>
                  <div class="u-mt-2 u-mb-2">
                     <div class="flex-between u-mb-1">
                        <span class="telemetry-value u-semibold" id="paramPercentage">0%</span>
                        <span class="u-text-secondary u-text-sm" id="paramCount">0/0 Parameters</span>
                     </div>
                     <div class="progress-track">
                        <div id="paramProgressBar" class="progress-fill" style="width:0%;"></div>
                     </div>
                  </div>
                  <div class="flex-row flex-wrap flex-gap-2">
                     <div class="stat-block">
                        <div class="stat-label">Download Status</div>
                        <div class="telemetry-value u-semibold" id="paramStatus">Not Started</div>
                     </div>
                     <div class="stat-block">
                        <div class="stat-label">Time Elapsed</div>
                        <div class="telemetry-value u-semibold" id="paramTimeElapsed">00:00</div>
                     </div>
                     <div class="stat-block">
                        <div class="stat-label">Est. Time Remaining</div>
                        <div class="telemetry-value u-semibold" id="paramTimeRemaining">--:--</div>
                     </div>
                  </div>
                  <div class="u-mt-3">
                     <div class="section-label u-mb-1">Category Progress</div>
                     <table class="data-table">
                        <thead>
                           <tr>
                              <th>Category</th>
                              <th>Progress</th>
                              <th>Count</th>
                           </tr>
                        </thead>
                        <tbody id="paramCategoriesTable"></tbody>
                     </table>
                  </div>
               </div>
            </div>
            <!-- Configs Tab -->
            <div class="tab-content tab-panel" id="configs-tab" style="display: none;">
               <h2 class="dashboard-title">Golden Config Snapshots</h2>
               <p class="hint-text">Save and restore up to 5 named parameter configurations for different quads or tunes.</p>
               <button id="saveConfigBtn" class="btn btn-primary u-mb-3">
                  <i class="fas fa-plus"></i> Save Current Config
               </button>
               <div id="saveConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
                  <div class="panel" style="width:400px; padding:var(--space-4);">
                     <h3 class="section-title">Save Config Snapshot</h3>
                     <input type="text" id="configNameInput" placeholder="e.g. 5inch-freestyle-6S" class="form-control u-mb-2">
                     <div class="flex-row u-justify-end">
                        <button id="cancelConfigBtn" class="btn btn-ghost">Cancel</button>
                        <button id="confirmSaveConfigBtn" class="btn btn-primary">Save</button>
                     </div>
                  </div>
               </div>
               <div id="configList" class="flex-col flex-gap-2">
                  <div class="u-text-secondary" style="text-align:center;padding:var(--space-4);">Loading configs...</div>
               </div>
            </div>
            <!-- Calibration Tab -->
            <div class="tab-content tab-panel" id="calibration-tab" style="display: none;">
               <h2 class="dashboard-title">Field Calibration</h2>
               <p class="hint-text">Trigger on-board calibration routines directly from the web UI.</p>
               <!-- 3D Quad Model -->
               <div class="card cal3d-card u-mb-3">
                  <div id="cal3dContainer">
                     <div id="cal3dAttitude" class="telemetry-value">
                        R: <span id="cal3dRoll">0.0</span>&deg; &nbsp; P: <span id="cal3dPitch">0.0</span>&deg; &nbsp; Y: <span id="cal3dYaw">0.0</span>&deg;
                     </div>
                  </div>
               </div>
               <div class="flex-row flex-wrap flex-gap-2">
                  <div class="card cal-card" data-cal="gyro">
                     <div class="card-title"><i class="fas fa-sync-alt"></i> Gyro Calibration</div>
                     <p class="hint-text">Keep the drone still on a flat surface. Takes ~2 seconds.</p>
                     <button class="cal-btn btn btn-primary" data-cal="gyro">
                        <i class="fas fa-play"></i> Start Gyro Cal
                     </button>
                     <div class="cal-status" data-cal="gyro">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="level">
                     <div class="card-title"><i class="fas fa-balance-scale"></i> Level Calibration</div>
                     <p class="hint-text">Place drone on a level surface. Calibrates accelerometer level.</p>
                     <button class="cal-btn btn btn-primary" data-cal="level">
                        <i class="fas fa-play"></i> Start Level Cal
                     </button>
                     <div class="cal-status" data-cal="level">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="accel">
                     <div class="card-title"><i class="fas fa-arrows-alt"></i> Accelerometer Calibration</div>
                     <p class="hint-text">Multi-step: you will need to place the drone in 6 orientations.</p>
                     <button class="cal-btn btn btn-primary" data-cal="accel">
                        <i class="fas fa-play"></i> Start Accel Cal
                     </button>
                     <div class="cal-status" data-cal="accel">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="compass">
                     <div class="card-title"><i class="fas fa-compass"></i> Compass Calibration</div>
                     <p class="hint-text">Rotate drone in all orientations during calibration.</p>
                     <button class="cal-btn btn btn-primary" data-cal="compass">
                        <i class="fas fa-play"></i> Start Compass Cal
                     </button>
                     <div class="cal-status" data-cal="compass">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="baro">
                     <div class="card-title"><i class="fas fa-thermometer-half"></i> Barometer Calibration</div>
                     <p class="hint-text">Calibrate barometer ground pressure. Keep drone stationary.</p>
                     <button class="cal-btn btn btn-primary" data-cal="baro">
                        <i class="fas fa-play"></i> Start Baro Cal
                     </button>
                     <div class="cal-status" data-cal="baro">Idle</div>
                  </div>
               </div>

               <!-- MAGFit Motor Interference Wizard -->
               <div class="card magfit-card u-mt-3" id="magfitCard">
                  <div class="card-title">
                     <i class="fas fa-magnet"></i> Motor Interference (MAGFit)
                     <span class="magfit-src-badge" id="magfitSrcBadge" style="display:none;"></span>
                  </div>
                  <p class="hint-text">
                     Fit <code>COMPASS_MOT_X/Y/Z</code> compensation coefficients from a flight log.
                     Load a log in the <strong>Logs</strong> tab first, then click Analyse.
                  </p>

                  <!-- Current COMPASS_MOT values -->
                  <div class="magfit-current-row" id="magfitCurrentRow">
                     <span class="magfit-cur-label">Current params:</span>
                     <span class="magfit-cur-val">COMPASS_MOT_X&nbsp;=&nbsp;<span id="mfCurX">--</span></span>
                     <span class="magfit-cur-val">COMPASS_MOT_Y&nbsp;=&nbsp;<span id="mfCurY">--</span></span>
                     <span class="magfit-cur-val">COMPASS_MOT_Z&nbsp;=&nbsp;<span id="mfCurZ">--</span></span>
                  </div>

                  <!-- Analyse button -->
                  <div class="magfit-actions-top">
                     <button id="magfitRunBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-chart-scatter"></i> Analyse Log
                     </button>
                     <span id="magfitRunStatus" class="hint-text" style="margin-left:0.75rem;"></span>
                  </div>

                  <!-- Results panel — hidden until analysis done -->
                  <div id="magfitResults" style="display:none;">

                     <!-- Axis selector + chart -->
                     <div class="magfit-chart-header">
                        <span class="filter-ctrl-label">ΔMag (Earth frame) vs <span id="magfitIndLabel">Throttle</span>:</span>
                        <button class="magfit-axis-btn active" data-mfaxis="x">X</button>
                        <button class="magfit-axis-btn" data-mfaxis="y">Y</button>
                        <button class="magfit-axis-btn" data-mfaxis="z">Z</button>
                        <span class="magfit-legend">
                           <span class="magfit-legend-dot raw"></span> Raw &nbsp;
                           <span class="magfit-legend-dot corr"></span> Corrected
                        </span>
                     </div>
                     <div class="spectrum-chart-wrap" style="height:260px;">
                        <canvas id="magfitCanvas"></canvas>
                     </div>

                     <!-- Numeric results -->
                     <div class="magfit-result-grid" id="magfitResultGrid">
                        <!-- filled by JS -->
                     </div>

                     <!-- Armed warning + Apply -->
                     <div class="magfit-apply-row">
                        <div id="magfitArmedWarn" class="magfit-armed-warn" style="display:none;">
                           <i class="fas fa-exclamation-triangle"></i>
                           Disarm the vehicle before writing compass parameters.
                        </div>
                        <button id="magfitApplyBtn" class="btn btn-success btn-sm" style="display:none;" disabled>
                           <i class="fas fa-upload"></i> Apply to FC
                        </button>
                        <button id="magfitClearBtn" class="btn btn-ghost btn-sm" style="display:none;">
                           <i class="fas fa-times"></i> Clear
                        </button>
                     </div>

                  </div>
               </div>

            </div>
            <!-- Motors Tab -->
            <div class="tab-content tab-panel" id="motors-tab" style="display: none;">
               <h2 class="dashboard-title">Motor Testing</h2>
               <div id="motorSafetyBanner" class="motor-safety-banner">
                  <div class="motor-safety-warning">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span>Remove all propellers before testing! Motors will spin.</span>
                  </div>
                  <div class="flex-row u-mt-1">
                     <label class="motor-safety-toggle">
                        <input type="checkbox" id="motorEnableToggle">
                        <span class="motor-toggle-slider"></span>
                     </label>
                     <span id="motorEnableLabel" class="u-semibold u-text-danger">Motor Test DISABLED</span>
                  </div>
                  <div id="motorArmedWarning" class="motor-armed-warning" style="display: none;">
                     <i class="fas fa-shield-alt"></i> ARM DETECTED — motor test disabled
                  </div>
               </div>
               <div class="motor-test-layout">
                  <div class="motor-sliders-row">
                     <div class="motor-test-card" id="motorTestCard1">
                        <div class="motor-test-title">Motor 1</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal1">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider1" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label class="telemetry-label">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur1" disabled>
                           <button class="motor-test-btn" id="motorTestBtn1" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn1" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp1">--</div>
                     </div>
                     <div class="motor-test-card" id="motorTestCard2">
                        <div class="motor-test-title">Motor 2</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal2">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider2" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label class="telemetry-label">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur2" disabled>
                           <button class="motor-test-btn" id="motorTestBtn2" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn2" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp2">--</div>
                     </div>
                     <div class="motor-quad-diagram">
                        <svg viewBox="0 0 200 200" width="160" height="160">
                           <line x1="40" y1="40" x2="160" y2="160" stroke="#555" stroke-width="3"/>
                           <line x1="160" y1="40" x2="40" y2="160" stroke="#555" stroke-width="3"/>
                           <rect x="80" y="80" width="40" height="40" rx="6" fill="var(--dark-color)"/>
                           <text x="100" y="105" text-anchor="middle" fill="white" font-size="12" font-weight="bold">FC</text>
                           <polygon points="100,70 94,82 106,82" fill="var(--danger-color)"/>
                           <circle id="motorDiag1" cx="40" cy="40" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="40" y="44" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M1</text>
                           <circle id="motorDiag2" cx="160" cy="40" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="160" y="44" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M2</text>
                           <circle id="motorDiag3" cx="40" cy="160" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="40" y="164" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M3</text>
                           <circle id="motorDiag4" cx="160" cy="160" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="160" y="164" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M4</text>
                        </svg>
                     </div>
                     <div class="motor-test-card" id="motorTestCard3">
                        <div class="motor-test-title">Motor 3</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal3">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider3" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label class="telemetry-label">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur3" disabled>
                           <button class="motor-test-btn" id="motorTestBtn3" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn3" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp3">--</div>
                     </div>
                     <div class="motor-test-card" id="motorTestCard4">
                        <div class="motor-test-title">Motor 4</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal4">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider4" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label class="telemetry-label">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur4" disabled>
                           <button class="motor-test-btn" id="motorTestBtn4" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn4" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp4">--</div>
                     </div>
                  </div>
               </div>
               <!-- Motor Output Chart -->
               <div class="motor-chart-panel card">
                  <div class="motor-chart-title">MOTOR OUTPUT (PWM μs)</div>
                  <div class="motor-chart-wrap">
                     <canvas id="motorRollingChart"></canvas>
                  </div>
               </div>

               <div class="card u-mt-2">
                  <div class="flex-between u-mb-1">
                     <div class="card-title u-mb-0">ESC TELEMETRY</div>
                     <div class="flex-row flex-gap-1">
                        <span class="u-text-dim">Protocol:</span>
                        <span id="escProtocolBadge" class="badge badge-info">--</span>
                     </div>
                  </div>
                  <table class="subsystem-table" id="escTelemetryTable">
                     <thead>
                        <tr>
                           <th>MOTOR</th>
                           <th>RPM / PWM</th>
                           <th>TEMP (&deg;C)</th>
                           <th>VOLTAGE (V)</th>
                           <th>CURRENT (A)</th>
                           <th>STATUS</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr><td>1</td><td id="escRpm1">--</td><td id="escTemp1">--</td><td id="escVolt1">--</td><td id="escCurr1">--</td><td id="escStatus1">--</td></tr>
                        <tr><td>2</td><td id="escRpm2">--</td><td id="escTemp2">--</td><td id="escVolt2">--</td><td id="escCurr2">--</td><td id="escStatus2">--</td></tr>
                        <tr><td>3</td><td id="escRpm3">--</td><td id="escTemp3">--</td><td id="escVolt3">--</td><td id="escCurr3">--</td><td id="escStatus3">--</td></tr>
                        <tr><td>4</td><td id="escRpm4">--</td><td id="escTemp4">--</td><td id="escVolt4">--</td><td id="escCurr4">--</td><td id="escStatus4">--</td></tr>
                     </tbody>
                  </table>
               </div>
            </div>
            <!-- RC & Modes Tab -->
            <div class="tab-content tab-panel tab-panel-cockpit" id="receiver-tab" style="display: none;">

               <!-- Signal header -->
               <div class="rc-header-strip">
                  <div class="rc-signal-group">
                     <span class="rc-dot" id="rcStatusDot"></span>
                     <span class="rc-chip" id="rcProtocolChip">--</span>
                     <span class="rc-chip" id="rcUartChip">--</span>
                     <span class="rc-chip" id="rcChCountChip">CH --</span>
                  </div>
                  <div class="rc-rssi-group">
                     <span class="rc-rssi-label">RSSI</span>
                     <div class="rc-rssi-track"><div class="rc-rssi-fill" id="rcRssiFill"></div></div>
                     <span class="rc-rssi-pct" id="rcRssiPct">--%</span>
                  </div>
               </div>

               <!-- Cockpit row: Left gimbal | 3D drone | Right gimbal -->
               <div class="rc-cockpit">

                  <div class="rc-gimbal-wrap">
                     <div class="rc-gimbal-valrow">
                        <span class="rc-gimbal-axis-label">THR</span>
                        <span class="rc-gimbal-val" id="rcGimbalLeftY">----</span>
                     </div>
                     <div class="rc-gimbal-box" id="rcGimbalLeft">
                        <span class="rc-crosshair rc-cv"></span>
                        <span class="rc-crosshair rc-ch"></span>
                        <div class="rc-deadband-ring" id="rcDeadbandLeft" style="width:30px;height:30px;"></div>
                        <div class="rc-stick-dot" id="rcDotLeft"></div>
                     </div>
                     <div class="rc-gimbal-valrow">
                        <span class="rc-gimbal-axis-label">YAW</span>
                        <span class="rc-gimbal-val" id="rcGimbalLeftX">----</span>
                     </div>
                  </div>

                  <div class="rc-drone-panel" id="rcDroneContainer"></div>

                  <div class="rc-gimbal-wrap">
                     <div class="rc-gimbal-valrow">
                        <span class="rc-gimbal-axis-label">PIT</span>
                        <span class="rc-gimbal-val" id="rcGimbalRightY">----</span>
                     </div>
                     <div class="rc-gimbal-box" id="rcGimbalRight">
                        <span class="rc-crosshair rc-cv"></span>
                        <span class="rc-crosshair rc-ch"></span>
                        <div class="rc-deadband-ring" id="rcDeadbandRight" style="width:30px;height:30px;"></div>
                        <div class="rc-stick-dot" id="rcDotRight"></div>
                     </div>
                     <div class="rc-gimbal-valrow">
                        <span class="rc-gimbal-axis-label">ROLL</span>
                        <span class="rc-gimbal-val" id="rcGimbalRightX">----</span>
                     </div>
                  </div>

               </div>

               <!-- Bottom: channel bars (left) + flight modes (right) -->
               <div class="rc-bottom">

                  <!-- Channel bars section -->
                  <div class="rc-bottom-left">
                     <div class="rc-section">
                        <div class="rc-section-title">RC CHANNELS</div>
                        <div id="rcChmapRow" class="rc-chmap-row"></div>
                        <div id="rcChannelsPanel"></div>
                     </div>
                  </div>

                  <!-- Flight modes section -->
                  <div class="rc-bottom-right">
                     <div class="rc-section">
                        <div class="rc-modes-header">
                           <span class="rc-section-title rc-section-title--inline">FLIGHT MODES</span>
                           <span class="rc-mode-active-badge" id="rcCurrentModeBadge">--</span>
                        </div>
                        <div class="rc-mode-slots" id="rcModeSlots"></div>
                     </div>
                  </div>

               </div>

               <!-- Config panels: Read -> Edit -> Preview -> Apply -> Verify -->
               <div class="rc-config-grid">
                  <div class="rc-config-card">
                     <div class="rc-config-header">
                        <span class="rc-section-title rc-section-title--inline">RC MAPPING</span>
                        <div class="rc-config-actions">
                           <button class="modal-button cancel-button" id="rcMapRefreshBtn">Refresh</button>
                           <button class="modal-button cancel-button" id="rcMapPreviewBtn">Preview</button>
                           <button class="modal-button connect-button" id="rcMapApplyBtn">Apply</button>
                        </div>
                     </div>
                     <div id="rcMapForm" class="rc-config-form"></div>
                     <div id="rcMapStatus" class="rc-config-status"></div>
                     <div id="rcMapDiff" class="rc-config-diff"></div>
                  </div>

                  <div class="rc-config-card">
                     <div class="rc-config-header">
                        <span class="rc-section-title rc-section-title--inline">FLIGHT MODES CONFIG</span>
                        <div class="rc-config-actions">
                           <button class="modal-button cancel-button" id="fltModesRefreshBtn">Refresh</button>
                           <button class="modal-button cancel-button" id="fltModesPreviewBtn">Preview</button>
                           <button class="modal-button connect-button" id="fltModesApplyBtn">Apply</button>
                        </div>
                     </div>
                     <div id="fltModesForm" class="rc-config-form"></div>
                     <div id="fltModesStatus" class="rc-config-status"></div>
                     <div id="fltModesDiff" class="rc-config-diff"></div>
                  </div>

                  <div class="rc-config-card">
                     <div class="rc-config-header">
                        <span class="rc-section-title rc-section-title--inline">FAILSAFE CONFIG</span>
                        <div class="rc-config-actions">
                           <button class="modal-button cancel-button" id="failsafeRefreshBtn">Refresh</button>
                           <button class="modal-button cancel-button" id="failsafePreviewBtn">Preview</button>
                           <button class="modal-button connect-button" id="failsafeApplyBtn">Apply</button>
                        </div>
                     </div>
                     <div id="failsafeForm" class="rc-config-form"></div>
                     <div id="failsafeStatus" class="rc-config-status"></div>
                     <div id="failsafeDiff" class="rc-config-diff"></div>
                  </div>

                  <div class="rc-config-card">
                     <div class="rc-config-header">
                        <span class="rc-section-title rc-section-title--inline">AUXILIARY SWITCH ASSIGNMENTS</span>
                        <div class="rc-config-actions">
                           <button class="modal-button cancel-button" id="auxRefreshBtn">Refresh</button>
                           <button class="modal-button cancel-button" id="auxPreviewBtn">Preview</button>
                           <button class="modal-button connect-button" id="auxApplyBtn">Apply</button>
                        </div>
                     </div>
                     <div id="auxFunctionsForm" class="rc-config-form rc-config-form-wide"></div>
                     <div id="auxStatus" class="rc-config-status"></div>
                     <div id="auxDiff" class="rc-config-diff"></div>
                  </div>
               </div>

            </div>

            <!-- Drone View Tab -->
            <div class="tab-content tab-panel tab-panel-cockpit" id="drone-view-tab" style="display: none;">
               <div class="drone-view-container">
                  <!-- Top bar: mode + armed + heading -->
                  <div class="drone-top-bar">
                     <div class="drone-hud-badge drone-mode-badge" id="dvModeBadge">STABILIZE</div>
                     <div class="drone-heading-display">HDG <span id="dvHeading">0</span>&deg;</div>
                     <div class="drone-hud-badge drone-armed-badge disarmed" id="dvArmedBadge">DISARMED</div>
                  </div>
                  <!-- Main area: altitude | canvas | climb -->
                  <div class="drone-main-area">
                     <div class="drone-altitude-panel">
                        <div class="drone-altitude-label">ALT</div>
                        <div class="drone-altitude-value" id="dvAltitude">0.0</div>
                        <div class="drone-altitude-unit">m</div>
                     </div>
                     <div class="drone-canvas-wrapper" id="dvCanvasWrapper">
                        <div id="dv3dContainer"></div>
                     </div>
                     <div class="drone-altitude-panel">
                        <div class="drone-altitude-label">V/S</div>
                        <div class="drone-altitude-value" id="dvClimb">0.0</div>
                        <div class="drone-altitude-unit">m/s</div>
                     </div>
                  </div>
                  <!-- Attitude readout -->
                  <div class="drone-attitude-readout">
                     <span>R: <span id="dvRoll">0.0</span>&deg;</span>
                     <span>P: <span id="dvPitch">0.0</span>&deg;</span>
                     <span>Y: <span id="dvYaw">0.0</span>&deg;</span>
                  </div>
                  <!-- Motor bars -->
                  <div class="drone-motor-bars">
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M1</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor1"></div></div>
                        <div class="drone-motor-pct" id="dvMotor1Pct">0%</div>
                     </div>
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M2</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor2"></div></div>
                        <div class="drone-motor-pct" id="dvMotor2Pct">0%</div>
                     </div>
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M3</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor3"></div></div>
                        <div class="drone-motor-pct" id="dvMotor3Pct">0%</div>
                     </div>
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M4</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor4"></div></div>
                        <div class="drone-motor-pct" id="dvMotor4Pct">0%</div>
                     </div>
                  </div>
                  <!-- Configurable OSD -->
                  <div class="drone-osd-container" id="dvOsdContainer"></div>
                  <button class="drone-osd-config-btn" id="dvOsdConfigBtn" title="Configure OSD fields">
                     <i class="fas fa-cog"></i> OSD
                  </button>
               </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content tab-panel" id="settings-tab" style="display: none;">
               <h2 class="dashboard-title"><i class="fas fa-cog"></i> Settings</h2>
               <div class="card u-mb-3">
                  <div class="card-title">API KEYS</div>
                  <p class="hint-text">
                     Configure API keys for AI providers. Keys are stored in <code>.env</code> on the device.
                  </p>
                  <div id="apiKeysContainer" class="flex-col flex-gap-2">
                     <!-- Gemini -->
                     <div class="api-key-card" data-provider="gemini">
                        <div class="flex-between u-mb-1">
                           <div class="flex-row flex-gap-1">
                              <i class="fas fa-robot" style="color: #4285f4;"></i>
                              <strong>Google Gemini</strong>
                           </div>
                           <span class="api-key-status" data-provider="gemini">Not configured</span>
                        </div>
                        <div class="api-key-preview" data-provider="gemini" style="display: none;"></div>
                        <div class="flex-row flex-gap-1">
                           <input type="password" class="api-key-input form-control u-flex-1" data-provider="gemini" placeholder="AIza...">
                           <button class="api-key-save btn btn-primary btn-sm" data-provider="gemini">
                              <i class="fas fa-save"></i> Save
                           </button>
                           <button class="api-key-delete btn btn-danger btn-sm btn-icon" data-provider="gemini" style="display: none;">
                              <i class="fas fa-trash"></i>
                           </button>
                        </div>
                     </div>
                     <!-- OpenAI -->
                     <div class="api-key-card" data-provider="openai">
                        <div class="flex-between u-mb-1">
                           <div class="flex-row flex-gap-1">
                              <i class="fas fa-brain" style="color: #10a37f;"></i>
                              <strong>OpenAI (GPT-4o)</strong>
                           </div>
                           <span class="api-key-status" data-provider="openai">Not configured</span>
                        </div>
                        <div class="api-key-preview" data-provider="openai" style="display: none;"></div>
                        <div class="flex-row flex-gap-1">
                           <input type="password" class="api-key-input form-control u-flex-1" data-provider="openai" placeholder="sk-...">
                           <button class="api-key-save btn btn-primary btn-sm" data-provider="openai">
                              <i class="fas fa-save"></i> Save
                           </button>
                           <button class="api-key-delete btn btn-danger btn-sm btn-icon" data-provider="openai" style="display: none;">
                              <i class="fas fa-trash"></i>
                           </button>
                        </div>
                     </div>
                     <!-- Anthropic -->
                     <div class="api-key-card" data-provider="claude">
                        <div class="flex-between u-mb-1">
                           <div class="flex-row flex-gap-1">
                              <i class="fas fa-comment-dots" style="color: #d97706;"></i>
                              <strong>Anthropic (Claude)</strong>
                           </div>
                           <span class="api-key-status" data-provider="claude">Not configured</span>
                        </div>
                        <div class="api-key-preview" data-provider="claude" style="display: none;"></div>
                        <div class="flex-row flex-gap-1">
                           <input type="password" class="api-key-input form-control u-flex-1" data-provider="claude" placeholder="sk-ant-...">
                           <button class="api-key-save btn btn-primary btn-sm" data-provider="claude">
                              <i class="fas fa-save"></i> Save
                           </button>
                           <button class="api-key-delete btn btn-danger btn-sm btn-icon" data-provider="claude" style="display: none;">
                              <i class="fas fa-trash"></i>
                           </button>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- OSD Configuration Modal -->
            <div class="modal" id="osdConfigModal">
               <div class="modal-content modal-content-dark">
                  <div class="modal-title">Configure OSD</div>
                  <p class="hint-text">Select fields to display on the drone view.</p>
                  <div id="osdFieldList"></div>
                  <div class="modal-buttons u-mt-2">
                     <button class="modal-button cancel-button" id="osdConfigClose">Close</button>
                     <button class="modal-button connect-button" id="osdConfigClear">Clear All</button>
                  </div>
               </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-container" id="chat-container">
               <h2 class="chat-title">AI Assistant</h2>
               <div class="chat-provider-row" id="chatProviderRow">
                  <select id="chatProviderSelect" class="chat-provider-select">
                     <option value="gemini">Gemini</option>
                     <option value="openai">OpenAI (GPT-4o)</option>
                     <option value="claude">Claude</option>
                  </select>
               </div>
               <div class="chat-messages" id="chatMessages">
               </div>
               <div class="chat-input">
                  <input type="text" class="chat-input-field" id="chatInput" placeholder="Ask a question about your drone...">
                  <button class="voice-button" id="voiceButton">
                     <i class="fas fa-microphone"></i>
                  </button>
                  <button class="send-button" id="sendButton">
                     <i class="fas fa-paper-plane"></i>
                  </button>
               </div>
               <div class="voice-status-indicator" id="voiceStatusIndicator"></div>
            </div>
         </div>
      </div>
      <!-- Connection Modal -->
      <div class="modal" id="connectionModal">
         <div class="modal-content">
            <div class="modal-title">Connect to Drone</div>
            <div class="form-group flex-row flex-gap-3">
               <label><input type="radio" name="connType" value="serial" checked onchange="toggleConnFields()"> Serial</label>
               <label><input type="radio" name="connType" value="ip" onchange="toggleConnFields()"> IP (UDP)</label>
            </div>
            <div id="serialFields">
               <div class="form-group">
                  <label for="portInput">Port:</label>
                  <input type="text" id="portInput" value="COM3" placeholder="COM3">
               </div>
               <div class="form-group">
                  <label for="baudInput">Baud Rate:</label>
                  <input type="text" id="baudInput" value="115200" placeholder="115200">
               </div>
            </div>
            <div id="ipFields" style="display:none;">
               <div class="form-group">
                  <label for="ipAddressInput">IP Address:</label>
                  <input type="text" id="ipAddressInput" value="0.0.0.0" placeholder="0.0.0.0">
               </div>
               <div class="form-group">
                  <label for="udpPortInput">Port:</label>
                  <input type="text" id="udpPortInput" value="14550" placeholder="14550">
               </div>
            </div>
            <div class="modal-buttons">
               <button class="modal-button cancel-button" id="cancelConnect">Cancel</button>
               <button class="modal-button connect-button" id="confirmConnect">Connect</button>
            </div>
         </div>
      </div>
      <!-- Scripts: core first, then tab modules -->
      <script defer src="/static/js/core.js"></script>
      <script defer src="/static/js/tabs/latency.js"></script>
      <script defer src="/static/js/tabs/motors.js"></script>
      <script defer src="/static/js/tabs/rc-modes.js"></script>
      <script defer src="/static/js/tabs/chat.js"></script>
      <script defer src="/static/js/tabs/parameters.js"></script>
      <script defer src="/static/js/tabs/configs.js"></script>
      <script defer src="/static/js/tabs/calibration.js"></script>
      <script defer src="/static/js/tabs/firmware.js"></script>
      <script defer src="/static/js/tabs/logs.js"></script>
      <script defer src="/static/js/tabs/serial-ports.js"></script>
      <script defer src="/static/js/tabs/drone-view.js"></script>
      <script defer src="/static/js/tabs/settings.js"></script>
   </body>
</html>
