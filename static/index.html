<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>UAV-AI Assistant</title>
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
      <link rel="stylesheet" href="/static/css/style.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
   </head>
   <body>
      <!-- Header -->
      <header>
         <div class="logo">UAV-AI Assistant</div>
         <div class="connection-status">
            <span id="connectionText">Disconnected</span>
            <div class="status-indicator" id="connectionIndicator"></div>
            <span id="headerParamsText" style="margin-left: 15px; display: none;">Params: <span id="headerParamsValue">0%</span></span>
            <span id="headerLatencyText" style="margin-left: 15px; display: none;">Latency: <span id="headerLatencyValue">0ms</span></span>
            <div id="copilotBadge" class="copilot-badge" style="display:none;" title="Click to toggle co-pilot mode. Shift+click for auto mode.">
               <i class="fas fa-robot"></i> CO-PILOT
            </div>
            <button class="panel-toggle-btn" id="toggleSidebar" title="Toggle sidebar">
               <i class="fas fa-bars"></i>
            </button>
            <button class="panel-toggle-btn" id="toggleChat" title="Toggle chat panel">
               <i class="fas fa-comment"></i>
            </button>
         </div>
      </header>
      <!-- Main Container -->
      <div class="container">
         <!-- Sidebar -->
         <div class="sidebar">
            <div class="drone-selector" id="connectButton">
               <span>Connect Drone</span>
               <i class="fas fa-chevron-down"></i>
            </div>
            <div class="drone-selector" id="disconnectButton" style="display: none; background-color: var(--danger-color); cursor: pointer;">
               <span>Disconnect Drone</span>
               <i class="fas fa-times"></i>
            </div>
            <div class="menu-item active" data-tab="dashboard">
               <i class="fas fa-tachometer-alt"></i>
               Dashboard
            </div>
            <div class="menu-item" data-tab="serial-ports">
               <i class="fas fa-plug"></i>
               Serial Ports
            </div>
            <div class="menu-item" data-tab="calibration">
               <i class="fas fa-crosshairs"></i>
               Calibration
            </div>
            <div class="menu-item" data-tab="firmware">
               <i class="fas fa-microchip"></i>
               Firmware
            </div>
            <div class="menu-item" data-tab="parameters">
               <i class="fas fa-sliders-h"></i>
               Parameters
            </div>
            <div class="menu-item" data-tab="logs">
               <i class="fas fa-file-alt"></i>
               Logs
            </div>
            <div class="menu-item" data-tab="latency-params">
               <i class="fas fa-tachometer-alt"></i>
               Latency & Parameters
            </div>
            <div class="menu-item" data-tab="configs">
               <i class="fas fa-save"></i>
               Configs
            </div>
            <div class="menu-item" data-tab="motors">
               <i class="fas fa-cog"></i>
               Motors
            </div>
            <div class="menu-item" data-tab="receiver">
               <i class="fas fa-broadcast-tower"></i>
               RC & Modes
            </div>
            <div class="menu-item" data-tab="drone-view">
               <i class="fas fa-plane"></i>
               Drone View
            </div>
            <div style="flex-grow: 1;"></div>
            <div class="menu-item" data-tab="settings">
               <i class="fas fa-cog"></i>
               Settings
            </div>
         </div>
         <!-- Main Content -->
         <div class="main-content">
            <!-- Dashboard -->
            <div class="dashboard tab-content active" id="dashboard-tab">
               <h2 class="dashboard-title">System Overview</h2>
               <!-- Top Cards -->
               <div class="cards-row">
                  <div class="card">
                     <div class="card-title">SYSTEM HEALTH</div>
                     <div class="system-health">
                        <div class="health-score">
                           <svg viewBox="0 0 36 36">
                              <path d="M18 2.0845
                                 a 15.9155 15.9155 0 0 1 0 31.831
                                 a 15.9155 15.9155 0 0 1 0 -31.831"
                                 fill="none"
                                 stroke="#e0e0e0"
                                 stroke-width="3"
                                 stroke-dasharray="100, 100"/>
                              <path id="healthScoreArc" d="M18 2.0845
                                 a 15.9155 15.9155 0 0 1 0 31.831
                                 a 15.9155 15.9155 0 0 1 0 -31.831"
                                 fill="none"
                                 stroke="#e74c3c"
                                 stroke-width="3"
                                 stroke-dasharray="68, 100"/>
                           </svg>
                           <div class="health-score-text" id="healthScoreText">--</div>
                        </div>
                        <div class="health-issues" id="healthIssues">-- CRITICAL ISSUES</div>
                     </div>
                  </div>
                  <div class="card">
                     <div class="card-title">FLIGHT READINESS</div>
                     <div class="flight-readiness">
                        <div class="readiness-indicator" id="readinessIndicator">--</div>
                        <div class="readiness-message" id="readinessMessage">--</div>
                     </div>
                  </div>
               </div>
               <!-- Status Cards -->
               <div class="cards-row">
                  <div class="card">
                     <div class="card-title">BATTERY STATUS</div>
                     <div class="status-bar">
                        <div class="status-indicator-bar" id="batteryIndicator" style="background-color: var(--warning-color);"></div>
                        <div class="status-text" id="batteryText">-- / -- Threshold</div>
                     </div>
                     <div class="critical-text" id="batteryStatus">--</div>
                  </div>
                  <div class="card">
                     <div class="card-title">GPS STATUS</div>
                     <div class="status-bar">
                        <div class="status-indicator-bar" id="gpsIndicator" style="background-color: var(--warning-color);"></div>
                        <div class="status-text" id="gpsText">Fix Type: -- (No Fix)</div>
                     </div>
                     <div class="critical-text" id="gpsSatellites">-- SATELLITES VISIBLE</div>
                  </div>
               </div>
               <!-- Motors Status Card -->
               <div class="card">
                  <div class="card-title">MOTORS STATUS</div>
                  <div class="motors-grid">
                     <div class="motor-card">
                        <div class="motor-title">Motor 1</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor1Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor1Status">--</div>
                     </div>
                     <div class="motor-card">
                        <div class="motor-title">Motor 2</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor2Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor2Status">--</div>
                     </div>
                     <div class="motor-card">
                        <div class="motor-title">Motor 3</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor3Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor3Status">--</div>
                     </div>
                     <div class="motor-card">
                        <div class="motor-title">Motor 4</div>
                        <div class="motor-gauge">
                           <svg viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="15" fill="none" stroke="#2ecc71" stroke-width="3"/>
                           </svg>
                           <div class="motor-output" id="motor4Output">--</div>
                        </div>
                        <div class="motor-label">Output</div>
                        <div class="motor-status" id="motor4Status">--</div>
                     </div>
                  </div>
               </div>
               <!-- Subsystem Status Table -->
               <!-- First-Run Tour Card -->
               <div class="card first-run-card" id="firstRunCard" style="display: none;">
                  <div class="card-title">Welcome to UAV-AI</div>
                  <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.75rem;">
                     New here? Follow these three steps to see UAV-AI in action.
                  </p>
                  <ol style="margin-left:1.25rem; font-size:0.85rem; color:var(--text-color);">
                     <li style="margin-bottom:0.4rem;">
                        <strong>Connect your drone:</strong>
                        Click <em>Connect Drone</em> in the left sidebar and choose Serial or UDP.
                     </li>
                     <li style="margin-bottom:0.4rem;">
                        <strong>Test Co-pilot:</strong>
                        In the chat, type <code>gps status</code> to get an instant answer (no cloud).
                     </li>
                     <li>
                        <strong>Ask JARVIS:</strong>
                        Once connected, ask <code>why is my compass off?</code> for a full AI diagnosis.
                     </li>
                  </ol>
                  <button id="dismissFirstRun" class="action-button" style="margin-top:0.75rem;">
                     Got it, hide this
                  </button>
               </div>
               <div class="card">
                  <div class="card-title">SUBSYSTEM STATUS</div>
                  <table class="subsystem-table" id="subsystemTable">
                     <thead>
                        <tr>
                           <th>COMPONENT</th>
                           <th>STATUS</th>
                           <th>DETAILS</th>
                        </tr>
                     </thead>
                     <tbody>
                     </tbody>
                  </table>
               </div>
               <!-- Firmware Information Card -->
               <div class="card">
                  <div class="card-title">FIRMWARE INFORMATION</div>
                  <table class="subsystem-table">
                     <tbody>
                        <tr>
                           <td>Firmware Version</td>
                           <td id="firmwareVersion">--</td>
                        </tr>
                        <tr>
                           <td>Custom Version</td>
                           <td id="customVersion">--</td>
                        </tr>
                        <tr>
                           <td>Board Version</td>
                           <td id="boardVersion">--</td>
                        </tr>
                        <tr>
                           <td>Vendor/Product ID</td>
                           <td id="vendorProductId">--</td>
                        </tr>
                        <tr>
                           <td>Capabilities</td>
                           <td id="capabilities">--</td>
                        </tr>
                     </tbody>
                  </table>
               </div>
            </div>
            <!-- Serial Ports Tab -->
            <div class="tab-content" id="serial-ports-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title">Serial Port Configuration</h2>
               <div class="card">
                  <div class="card-title">UART ASSIGNMENT</div>
                  <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">
                     Assign peripherals to serial ports. Changes require Save &amp; Reboot.
                  </p>
                  <div style="overflow-x:auto;">
                     <table class="serial-port-table" id="serialPortTable">
                        <thead>
                           <tr>
                              <th>Port</th>
                              <th>Label</th>
                              <th>Protocol</th>
                              <th>Baud Rate</th>
                           </tr>
                        </thead>
                        <tbody id="serialPortBody"></tbody>
                     </table>
                  </div>
                  <div style="margin-top:1rem; display:flex; gap:0.5rem; justify-content:flex-end;">
                     <button class="modal-button cancel-button" id="serialRefreshBtn">Refresh</button>
                     <button class="modal-button connect-button" id="serialSaveBtn">Save &amp; Reboot</button>
                  </div>
                  <div id="serialStatus" style="margin-top:0.5rem; font-size:0.85rem;"></div>
               </div>
            </div>
            <!-- Firmware Tab -->
            <div class="tab-content" id="firmware-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title">Firmware</h2>
               <p style="color: var(--text-muted); margin-bottom: 1rem;">Flash ArduPilot firmware from a local file or the online firmware server.</p>

               <!-- Current Firmware Info -->
               <div class="card" style="margin-bottom: 1rem;">
                  <div class="card-title"><i class="fas fa-info-circle"></i> Current Firmware</div>
                  <div id="fwCurrentInfo" style="font-size: 0.85rem; color: var(--text-muted);">
                     Not connected — connect a flight controller to see firmware info.
                  </div>
               </div>

               <!-- Flash Local File -->
               <div class="card" style="margin-bottom: 1rem;">
                  <div class="card-title"><i class="fas fa-file-upload"></i> Flash Local File</div>
                  <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem;">Select an ArduPilot <code>.apj</code> firmware file from your computer.</p>
                  <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                     <input type="file" id="fwLocalFile" accept=".apj" style="font-size: 0.85rem;">
                     <button id="fwFlashLocalBtn" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; white-space: nowrap;" disabled>
                        <i class="fas fa-bolt"></i> Flash Selected File
                     </button>
                  </div>
                  <div id="fwLocalStatus" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);"></div>
               </div>

               <!-- Online Firmware -->
               <div class="card" style="margin-bottom: 1rem;">
                  <div class="card-title"><i class="fas fa-cloud-download-alt"></i> Online Firmware</div>
                  <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.75rem;">
                     <select id="fwVehicleFilter" style="padding: 0.4rem 0.6rem; border-radius: 5px; border: 1px solid var(--border-color); font-size: 0.85rem;">
                        <option value="">All Vehicle Types</option>
                        <option value="Copter">Copter</option>
                        <option value="Plane">Plane</option>
                        <option value="Rover">Rover</option>
                        <option value="Sub">Sub</option>
                        <option value="Tracker">Tracker</option>
                        <option value="Heli">Heli</option>
                     </select>
                     <button id="fwRefreshManifest" style="background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; padding: 0.4rem 0.8rem; cursor: pointer; font-size: 0.85rem;">
                        <i class="fas fa-sync-alt"></i> Refresh
                     </button>
                  </div>
                  <div id="fwOnlineList" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;">
                     <p style="color: var(--text-muted);">Click Refresh to fetch available firmware.</p>
                  </div>
               </div>

               <!-- Flash Progress -->
               <div class="card" id="fwProgressCard" style="margin-bottom: 1rem; display: none;">
                  <div class="card-title"><i class="fas fa-tasks"></i> Flash Progress</div>
                  <div id="fwProgressStage" style="font-weight: 600; margin-bottom: 0.5rem;">Idle</div>
                  <div style="background: var(--bg-color); border-radius: 5px; overflow: hidden; height: 20px; margin-bottom: 0.5rem;">
                     <div id="fwProgressBar" style="height: 100%; width: 0%; background: var(--primary-color); transition: width 0.3s ease; border-radius: 5px;"></div>
                  </div>
                  <div id="fwProgressLog" style="background: #1a1a2e; color: #a0ffa0; font-family: monospace; font-size: 0.75rem; padding: 0.75rem; border-radius: 5px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
               </div>
            </div>

            <!-- Parameters Tab -->
            <div class="tab-content" id="parameters-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title">Parameters</h2>
               <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                  <div style="display: flex; align-items: center;">
                     <input type="text" id="paramSearch" placeholder="Search parameters..." style="padding: 0.5rem; border-radius: 5px; border: 1px solid #ddd; margin-right: 0.5rem;">
                     <button id="searchBtn" class="action-button" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer;">
                     <i class="fas fa-search"></i>
                     </button>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                     <select id="categoryFilter" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="All Categories">All Categories</option>
                        <option value="System">System</option>
                        <option value="GPS">GPS</option>
                        <option value="Battery">Battery</option>
                        <option value="Serial">Serial</option>
                        <option value="Compass">Compass</option>
                        <option value="IMU">IMU</option>
                        <option value="Navigation">Navigation</option>
                        <option value="Motors">Motors</option>
                        <option value="Servos">Servos</option>
                        <option value="RC">RC</option>
                        <option value="Flight Modes">Flight Modes</option>
                        <option value="Safety">Safety</option>
                        <option value="EKF">EKF</option>
                        <option value="AHRS">AHRS</option>
                        <option value="Control">Control</option>
                        <option value="Pilot">Pilot</option>
                        <option value="Landing">Landing</option>
                        <option value="Barometer">Barometer</option>
                        <option value="RangeFinder">RangeFinder</option>
                        <option value="RPM">RPM</option>
                        <option value="Notifications">Notifications</option>
                        <option value="OSD">OSD</option>
                        <option value="Logging">Logging</option>
                        <option value="Scheduler">Scheduler</option>
                        <option value="Streaming">Streaming</option>
                        <option value="Miscellaneous">Miscellaneous</option>
                     </select>
                     <button id="refreshParams" class="action-button" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer;">
                     <i class="fas fa-sync-alt"></i> Refresh
                     </button>
                     <button id="saveParams" class="action-button" style="background-color: var(--success-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer;">
                     <i class="fas fa-save"></i> Save Changes
                     </button>
                  </div>
               </div>
               <div style="overflow-x: auto; overflow-y: auto;">
                  <table id="parametersTable" style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                     <thead>
                        <tr style="background-color: var(--light-color); text-align: left;">
                           <th style="padding: 0.75rem; border-bottom: 1px solid #ddd;">Name</th>
                           <th style="padding: 0.75rem; border-bottom: 1px solid #ddd;">Value</th>
                           <th style="padding: 0.75rem; border-bottom: 1px solid #ddd;">Description</th>
                           <th style="padding: 0.75rem; border-bottom: 1px solid #ddd;">Range</th>
                           <th style="padding: 0.75rem; border-bottom: 1px solid #ddd;">Actions</th>
                        </tr>
                     </thead>
                     <tbody id="parametersTableBody">
                     </tbody>
                  </table>
               </div>
            </div>
            <!-- Logs Tab -->
            <div class="tab-content" id="logs-tab" style="display: none; flex: 1; background-color: var(--dark-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px); color: #e0e0e0;">

               <!-- Top: Upload + FC Fetch -->
               <div style="display: flex; gap: 1rem; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap;">
                  <!-- Upload area -->
                  <div class="log-upload-area" id="logUploadArea">
                     <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                     <p style="margin: 0.5rem 0 0.25rem; font-weight: bold;">Upload Log File</p>
                     <p style="font-size: 0.75rem; color: #888;">Drag & drop .bin or .tlog, or click to browse</p>
                     <input type="file" id="logFileInput" accept=".bin,.tlog" style="display:none;">
                  </div>
                  <!-- FC Fetch -->
                  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                     <button id="fetchLogsButton" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-download"></i> Fetch FC Logs
                     </button>
                     <div id="logContent" style="font-size: 0.8rem; color: #aaa;"></div>
                  </div>
               </div>

               <!-- Status bar -->
               <div class="log-status-bar" id="logStatusBar" style="display:none;">
                  <span id="logStatusText"></span>
               </div>

               <!-- Visualization area -->
               <div class="log-viz-area" id="logVizArea"></div>

            </div>
            <!-- Latency & Parameters Tab -->
            <div class="tab-content" id="latency-params-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title">Latency & Parameters</h2>
               <div class="card">
                  <div class="card-title">LATENCY MONITOR</div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                     <div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);" id="currentLatency">-- ms</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Current Latency</div>
                     </div>
                     <div>
                        <div style="font-size: 1.2rem; font-weight: bold;" id="avgLatency">-- ms</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Average</div>
                     </div>
                     <div>
                        <div style="font-size: 1.2rem; font-weight: bold;" id="maxLatency">-- ms</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Maximum</div>
                     </div>
                     <div>
                        <div style="font-size: 1.2rem; font-weight: bold;" id="minLatency">-- ms</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Minimum</div>
                     </div>
                  </div>
                  <div style="height: 200px; background-color: #f7f9fa; border-radius: 5px; padding: 1rem; position: relative; margin-bottom: 1rem;">
                     <canvas id="latencyChart" width="100%" height="100%"></canvas>
                     <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-muted); font-size: 0.9rem; display: none;" id="noLatencyData">No latency data available</div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                     <div style="width: 12px; height: 12px; border-radius: 50%;" id="latencyStatusIndicator"></div>
                     <div id="latencyStatusText">Latency Status: Unknown</div>
                  </div>
               </div>
               <div class="card" style="margin-top: 1rem;">
                  <div class="card-title">MAVLINK LINK STATS</div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);" id="linkPktRate">-- pkt/s</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Incoming Packet Rate</div>
                     </div>
                     <div>
                        <div style="font-size: 1.2rem; font-weight: bold;" id="linkByteRate">-- B/s</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Link Speed</div>
                     </div>
                  </div>
               </div>
               <div class="card" style="margin-top: 1rem;">
                  <div class="card-title">PARAMETERS DOWNLOAD PROGRESS</div>
                  <div style="margin: 1.5rem 0;">
                     <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.9rem; font-weight: bold;" id="paramPercentage">0%</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted);" id="paramCount">0/0 Parameters</div>
                     </div>
                     <div style="height: 20px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden;">
                        <div id="paramProgressBar" style="height: 100%; width: 0%; background-color: var(--primary-color); border-radius: 10px; transition: width 0.3s ease;"></div>
                     </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                     <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Download Status</div>
                        <div style="font-size: 1rem; font-weight: bold;" id="paramStatus">Not Started</div>
                     </div>
                     <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Time Elapsed</div>
                        <div style="font-size: 1rem; font-weight: bold;" id="paramTimeElapsed">00:00</div>
                     </div>
                     <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Estimated Time Remaining</div>
                        <div style="font-size: 1rem; font-weight: bold;" id="paramTimeRemaining">--:--</div>
                     </div>
                  </div>
                  <div style="margin-top: 1.5rem;">
                     <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem;">Category Progress</div>
                     <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                           <tr style="background-color: var(--light-color); text-align: left;">
                              <th style="padding: 0.5rem; font-size: 0.8rem;">Category</th>
                              <th style="padding: 0.5rem; font-size: 0.8rem;">Progress</th>
                              <th style="padding: 0.5rem; font-size: 0.8rem;">Count</th>
                           </tr>
                        </thead>
                        <tbody id="paramCategoriesTable">
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
            <!-- Configs Tab -->
            <div class="tab-content" id="configs-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title">Golden Config Snapshots</h2>
               <p style="color: var(--text-muted); margin-bottom: 1rem;">Save and restore up to 5 named parameter configurations for different quads or tunes.</p>
               <button id="saveConfigBtn" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.6rem 1.2rem; cursor: pointer; font-size: 0.9rem; margin-bottom: 1.5rem;">
                  <i class="fas fa-plus"></i> Save Current Config
               </button>
               <div id="saveConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                  <div style="background: white; border-radius: 10px; padding: 2rem; width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                     <h3 style="margin-bottom: 1rem;">Save Config Snapshot</h3>
                     <input type="text" id="configNameInput" placeholder="e.g. 5inch-freestyle-6S" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.95rem; margin-bottom: 1rem;">
                     <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button id="cancelConfigBtn" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">Cancel</button>
                        <button id="confirmSaveConfigBtn" style="padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; background: var(--primary-color); color: white;">Save</button>
                     </div>
                  </div>
               </div>
               <div id="configList" style="display: flex; flex-direction: column; gap: 1rem;">
                  <div style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading configs...</div>
               </div>
            </div>
            <!-- Calibration Tab -->
            <div class="tab-content" id="calibration-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title">Field Calibration</h2>
               <p style="color: var(--text-muted); margin-bottom: 1rem;">Trigger on-board calibration routines directly from the web UI.</p>
               <!-- 3D Quad Model -->
               <div class="card" style="margin-bottom: 1.5rem; padding: 0; overflow: hidden; background: #0d0d1a;">
                  <div id="cal3dContainer" style="width: 100%; height: 300px; position: relative;">
                     <div id="cal3dAttitude" style="position: absolute; bottom: 8px; left: 12px; font-size: 0.75rem; font-family: monospace; color: #8888aa; z-index: 1;">
                        R: <span id="cal3dRoll">0.0</span>&deg; &nbsp; P: <span id="cal3dPitch">0.0</span>&deg; &nbsp; Y: <span id="cal3dYaw">0.0</span>&deg;
                     </div>
                  </div>
               </div>
               <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                  <div class="card cal-card" data-cal="gyro" style="min-width: 200px; flex: 1;">
                     <div class="card-title"><i class="fas fa-sync-alt"></i> Gyro Calibration</div>
                     <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Keep the drone still on a flat surface. Takes ~2 seconds.</p>
                     <button class="cal-btn" data-cal="gyro" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; width: 100%;">
                        <i class="fas fa-play"></i> Start Gyro Cal
                     </button>
                     <div class="cal-status" data-cal="gyro" style="margin-top: 0.5rem; font-size: 0.8rem; text-align: center; color: var(--text-muted);">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="level" style="min-width: 200px; flex: 1;">
                     <div class="card-title"><i class="fas fa-balance-scale"></i> Level Calibration</div>
                     <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Place drone on a level surface. Calibrates accelerometer level.</p>
                     <button class="cal-btn" data-cal="level" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; width: 100%;">
                        <i class="fas fa-play"></i> Start Level Cal
                     </button>
                     <div class="cal-status" data-cal="level" style="margin-top: 0.5rem; font-size: 0.8rem; text-align: center; color: var(--text-muted);">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="accel" style="min-width: 200px; flex: 1;">
                     <div class="card-title"><i class="fas fa-arrows-alt"></i> Accelerometer Calibration</div>
                     <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Multi-step: you will need to place the drone in 6 orientations.</p>
                     <button class="cal-btn" data-cal="accel" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; width: 100%;">
                        <i class="fas fa-play"></i> Start Accel Cal
                     </button>
                     <div class="cal-status" data-cal="accel" style="margin-top: 0.5rem; font-size: 0.8rem; text-align: center; color: var(--text-muted);">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="compass" style="min-width: 200px; flex: 1;">
                     <div class="card-title"><i class="fas fa-compass"></i> Compass Calibration</div>
                     <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Rotate drone in all orientations during calibration.</p>
                     <button class="cal-btn" data-cal="compass" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; width: 100%;">
                        <i class="fas fa-play"></i> Start Compass Cal
                     </button>
                     <div class="cal-status" data-cal="compass" style="margin-top: 0.5rem; font-size: 0.8rem; text-align: center; color: var(--text-muted);">Idle</div>
                  </div>
                  <div class="card cal-card" data-cal="baro" style="min-width: 200px; flex: 1;">
                     <div class="card-title"><i class="fas fa-thermometer-half"></i> Barometer Calibration</div>
                     <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Calibrate barometer ground pressure. Keep drone stationary.</p>
                     <button class="cal-btn" data-cal="baro" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; width: 100%;">
                        <i class="fas fa-play"></i> Start Baro Cal
                     </button>
                     <div class="cal-status" data-cal="baro" style="margin-top: 0.5rem; font-size: 0.8rem; text-align: center; color: var(--text-muted);">Idle</div>
                  </div>
               </div>
            </div>
            <!-- Motors Tab -->
            <div class="tab-content" id="motors-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title">Motor Testing</h2>
               <div id="motorSafetyBanner" class="motor-safety-banner">
                  <div class="motor-safety-warning">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span>Remove all propellers before testing! Motors will spin.</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.75rem;">
                     <label class="motor-safety-toggle">
                        <input type="checkbox" id="motorEnableToggle">
                        <span class="motor-toggle-slider"></span>
                     </label>
                     <span id="motorEnableLabel" style="font-weight: bold; font-size: 0.9rem; color: var(--danger-color);">Motor Test DISABLED</span>
                  </div>
                  <div id="motorArmedWarning" class="motor-armed-warning" style="display: none;">
                     <i class="fas fa-shield-alt"></i> ARM DETECTED — motor test disabled
                  </div>
               </div>
               <div class="motor-test-layout">
                  <div class="motor-sliders-row">
                     <div class="motor-test-card" id="motorTestCard1">
                        <div class="motor-test-title">Motor 1</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal1">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider1" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label style="font-size:0.7rem; color: var(--text-muted);">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur1" disabled>
                           <button class="motor-test-btn" id="motorTestBtn1" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn1" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp1">--</div>
                     </div>
                     <div class="motor-test-card" id="motorTestCard2">
                        <div class="motor-test-title">Motor 2</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal2">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider2" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label style="font-size:0.7rem; color: var(--text-muted);">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur2" disabled>
                           <button class="motor-test-btn" id="motorTestBtn2" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn2" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp2">--</div>
                     </div>
                     <div class="motor-quad-diagram">
                        <svg viewBox="0 0 200 200" width="160" height="160">
                           <line x1="40" y1="40" x2="160" y2="160" stroke="#555" stroke-width="3"/>
                           <line x1="160" y1="40" x2="40" y2="160" stroke="#555" stroke-width="3"/>
                           <rect x="80" y="80" width="40" height="40" rx="6" fill="var(--dark-color)"/>
                           <text x="100" y="105" text-anchor="middle" fill="white" font-size="12" font-weight="bold">FC</text>
                           <polygon points="100,70 94,82 106,82" fill="var(--danger-color)"/>
                           <circle id="motorDiag1" cx="40" cy="40" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="40" y="44" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M1</text>
                           <circle id="motorDiag2" cx="160" cy="40" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="160" y="44" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M2</text>
                           <circle id="motorDiag3" cx="40" cy="160" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="40" y="164" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M3</text>
                           <circle id="motorDiag4" cx="160" cy="160" r="22" fill="#444" stroke="#666" stroke-width="2"/>
                           <text x="160" y="164" text-anchor="middle" fill="white" font-size="11" font-weight="bold">M4</text>
                        </svg>
                     </div>
                     <div class="motor-test-card" id="motorTestCard3">
                        <div class="motor-test-title">Motor 3</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal3">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider3" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label style="font-size:0.7rem; color: var(--text-muted);">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur3" disabled>
                           <button class="motor-test-btn" id="motorTestBtn3" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn3" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp3">--</div>
                     </div>
                     <div class="motor-test-card" id="motorTestCard4">
                        <div class="motor-test-title">Motor 4</div>
                        <div class="motor-slider-wrap">
                           <div class="motor-slider-value" id="motorSliderVal4">0%</div>
                           <input type="range" min="0" max="100" value="0" class="motor-vslider" id="motorSlider4" orient="vertical" disabled>
                        </div>
                        <div class="motor-test-controls">
                           <label style="font-size:0.7rem; color: var(--text-muted);">Duration (s)</label>
                           <input type="number" min="1" max="10" value="3" class="motor-duration-input" id="motorDur4" disabled>
                           <button class="motor-test-btn" id="motorTestBtn4" disabled><i class="fas fa-play"></i> Test</button>
                           <button class="motor-stop-btn" id="motorStopBtn4" disabled><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <div class="motor-response-status" id="motorResp4">--</div>
                     </div>
                  </div>
               </div>
               <div class="card" style="margin-top: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                     <div class="card-title" style="margin-bottom: 0;">ESC TELEMETRY</div>
                     <div style="font-size: 0.8rem;">
                        <span style="color: var(--text-muted);">Protocol:</span>
                        <span id="escProtocolBadge" style="background-color: var(--primary-color); color: white; padding: 0.2rem 0.6rem; border-radius: 10px; font-weight: bold; font-size: 0.75rem;">--</span>
                     </div>
                  </div>
                  <table class="subsystem-table" id="escTelemetryTable">
                     <thead>
                        <tr>
                           <th>MOTOR</th>
                           <th>RPM / PWM</th>
                           <th>TEMP (&deg;C)</th>
                           <th>VOLTAGE (V)</th>
                           <th>CURRENT (A)</th>
                           <th>STATUS</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr><td>1</td><td id="escRpm1">--</td><td id="escTemp1">--</td><td id="escVolt1">--</td><td id="escCurr1">--</td><td id="escStatus1">--</td></tr>
                        <tr><td>2</td><td id="escRpm2">--</td><td id="escTemp2">--</td><td id="escVolt2">--</td><td id="escCurr2">--</td><td id="escStatus2">--</td></tr>
                        <tr><td>3</td><td id="escRpm3">--</td><td id="escTemp3">--</td><td id="escVolt3">--</td><td id="escCurr3">--</td><td id="escStatus3">--</td></tr>
                        <tr><td>4</td><td id="escRpm4">--</td><td id="escTemp4">--</td><td id="escVolt4">--</td><td id="escCurr4">--</td><td id="escStatus4">--</td></tr>
                     </tbody>
                  </table>
               </div>
            </div>
            <!-- RC & Modes Tab -->
            <div class="tab-content" id="receiver-tab" style="display: none; flex: 1; background-color: #16162b; border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title" style="color: #e0e0e0;"><i class="fas fa-broadcast-tower"></i> RC & Modes</h2>
               <div class="rc-section">
                  <div class="rc-section-header">
                     <span class="rc-section-title">Receiver</span>
                     <div class="rc-rssi-badge" id="rcRssiBadge">RSSI: --</div>
                     <div class="rc-chancount-badge" id="rcChancountBadge">CH: --</div>
                     <div class="rc-rssi-badge" id="rcProtocolBadge">Protocol: --</div>
                     <div class="rc-rssi-badge" id="rcUartBadge">UART: --</div>
                  </div>
                  <div class="rc-bars-container" id="rcBarsContainer">
                  </div>
               </div>
               <div class="rc-section" style="margin-top: 1.5rem;">
                  <div class="rc-section-header">
                     <span class="rc-section-title">Flight Modes</span>
                     <div class="rc-mode-badge" id="rcCurrentModeBadge">-- (--)</div>
                  </div>
                  <table class="rc-mode-table" id="rcModeTable">
                     <thead>
                        <tr>
                           <th>Slot</th>
                           <th>Mode</th>
                           <th>PWM Range</th>
                           <th>Active</th>
                        </tr>
                     </thead>
                     <tbody id="rcModeTableBody">
                        <tr><td>1</td><td>--</td><td>&lt; 1230</td><td></td></tr>
                        <tr><td>2</td><td>--</td><td>1230 – 1360</td><td></td></tr>
                        <tr><td>3</td><td>--</td><td>1360 – 1490</td><td></td></tr>
                        <tr><td>4</td><td>--</td><td>1490 – 1620</td><td></td></tr>
                        <tr><td>5</td><td>--</td><td>1620 – 1749</td><td></td></tr>
                        <tr><td>6</td><td>--</td><td>&ge; 1749</td><td></td></tr>
                     </tbody>
                  </table>
               </div>
            </div>

            <!-- Drone View Tab -->
            <div class="tab-content" id="drone-view-tab" style="display: none; flex: 1; background-color: #0d0d1a; border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <div class="drone-view-container">
                  <!-- Top bar: mode + armed + heading -->
                  <div class="drone-top-bar">
                     <div class="drone-hud-badge drone-mode-badge" id="dvModeBadge">STABILIZE</div>
                     <div class="drone-heading-display">HDG <span id="dvHeading">0</span>&deg;</div>
                     <div class="drone-hud-badge drone-armed-badge disarmed" id="dvArmedBadge">DISARMED</div>
                  </div>
                  <!-- Main area: altitude | canvas | climb -->
                  <div class="drone-main-area">
                     <div class="drone-altitude-panel">
                        <div class="drone-altitude-label">ALT</div>
                        <div class="drone-altitude-value" id="dvAltitude">0.0</div>
                        <div class="drone-altitude-unit">m</div>
                     </div>
                     <div class="drone-canvas-wrapper" id="dvCanvasWrapper" style="position: relative;">
                        <div id="dv3dContainer" style="width: 100%; height: 100%;"></div>
                     </div>
                     <div class="drone-altitude-panel">
                        <div class="drone-altitude-label">V/S</div>
                        <div class="drone-altitude-value" id="dvClimb">0.0</div>
                        <div class="drone-altitude-unit">m/s</div>
                     </div>
                  </div>
                  <!-- Attitude readout -->
                  <div class="drone-attitude-readout">
                     <span>R: <span id="dvRoll">0.0</span>&deg;</span>
                     <span>P: <span id="dvPitch">0.0</span>&deg;</span>
                     <span>Y: <span id="dvYaw">0.0</span>&deg;</span>
                  </div>
                  <!-- Motor bars -->
                  <div class="drone-motor-bars">
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M1</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor1"></div></div>
                        <div class="drone-motor-pct" id="dvMotor1Pct">0%</div>
                     </div>
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M2</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor2"></div></div>
                        <div class="drone-motor-pct" id="dvMotor2Pct">0%</div>
                     </div>
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M3</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor3"></div></div>
                        <div class="drone-motor-pct" id="dvMotor3Pct">0%</div>
                     </div>
                     <div class="drone-motor-bar-item">
                        <div class="drone-motor-label">M4</div>
                        <div class="drone-motor-bar-track"><div class="drone-motor-bar-fill" id="dvMotor4"></div></div>
                        <div class="drone-motor-pct" id="dvMotor4Pct">0%</div>
                     </div>
                  </div>
                  <!-- Configurable OSD -->
                  <div class="drone-osd-container" id="dvOsdContainer"></div>
                  <button class="drone-osd-config-btn" id="dvOsdConfigBtn" title="Configure OSD fields">
                     <i class="fas fa-cog"></i> OSD
                  </button>
               </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings-tab" style="display: none; flex: 1; background-color: var(--white-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); overflow-y: auto; max-height: calc(100vh - 120px);">
               <h2 class="dashboard-title"><i class="fas fa-cog"></i> Settings</h2>
               <div class="card" style="margin-bottom: 1.5rem;">
                  <div class="card-title">API KEYS</div>
                  <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                     Configure API keys for AI providers. Keys are stored in <code>.env</code> on the device.
                  </p>
                  <div id="apiKeysContainer" style="display: flex; flex-direction: column; gap: 1rem;">
                     <!-- Gemini -->
                     <div class="api-key-card" data-provider="gemini" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                           <div style="display: flex; align-items: center; gap: 0.5rem;">
                              <i class="fas fa-robot" style="color: #4285f4;"></i>
                              <strong>Google Gemini</strong>
                           </div>
                           <span class="api-key-status" data-provider="gemini" style="font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 10px; background: #f0f0f0; color: var(--text-muted);">Not configured</span>
                        </div>
                        <div class="api-key-preview" data-provider="gemini" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-family: monospace; display: none;"></div>
                        <div style="display: flex; gap: 0.5rem;">
                           <input type="password" class="api-key-input" data-provider="gemini" placeholder="AIza..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85rem;">
                           <button class="api-key-save" data-provider="gemini" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem;">
                              <i class="fas fa-save"></i> Save
                           </button>
                           <button class="api-key-delete" data-provider="gemini" style="background-color: var(--danger-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.85rem; display: none;">
                              <i class="fas fa-trash"></i>
                           </button>
                        </div>
                     </div>
                     <!-- OpenAI -->
                     <div class="api-key-card" data-provider="openai" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                           <div style="display: flex; align-items: center; gap: 0.5rem;">
                              <i class="fas fa-brain" style="color: #10a37f;"></i>
                              <strong>OpenAI (GPT-4o)</strong>
                           </div>
                           <span class="api-key-status" data-provider="openai" style="font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 10px; background: #f0f0f0; color: var(--text-muted);">Not configured</span>
                        </div>
                        <div class="api-key-preview" data-provider="openai" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-family: monospace; display: none;"></div>
                        <div style="display: flex; gap: 0.5rem;">
                           <input type="password" class="api-key-input" data-provider="openai" placeholder="sk-..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85rem;">
                           <button class="api-key-save" data-provider="openai" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem;">
                              <i class="fas fa-save"></i> Save
                           </button>
                           <button class="api-key-delete" data-provider="openai" style="background-color: var(--danger-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.85rem; display: none;">
                              <i class="fas fa-trash"></i>
                           </button>
                        </div>
                     </div>
                     <!-- Anthropic -->
                     <div class="api-key-card" data-provider="claude" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                           <div style="display: flex; align-items: center; gap: 0.5rem;">
                              <i class="fas fa-comment-dots" style="color: #d97706;"></i>
                              <strong>Anthropic (Claude)</strong>
                           </div>
                           <span class="api-key-status" data-provider="claude" style="font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 10px; background: #f0f0f0; color: var(--text-muted);">Not configured</span>
                        </div>
                        <div class="api-key-preview" data-provider="claude" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-family: monospace; display: none;"></div>
                        <div style="display: flex; gap: 0.5rem;">
                           <input type="password" class="api-key-input" data-provider="claude" placeholder="sk-ant-..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85rem;">
                           <button class="api-key-save" data-provider="claude" style="background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem;">
                              <i class="fas fa-save"></i> Save
                           </button>
                           <button class="api-key-delete" data-provider="claude" style="background-color: var(--danger-color); color: white; border: none; border-radius: 5px; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.85rem; display: none;">
                              <i class="fas fa-trash"></i>
                           </button>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- OSD Configuration Modal -->
            <div class="modal" id="osdConfigModal">
               <div class="modal-content" style="max-width: 500px; background: #1a1a2e; color: #e0e0e0;">
                  <div class="modal-title" style="color: #e0e0e0;">Configure OSD</div>
                  <p style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">Select fields to display on the drone view.</p>
                  <div id="osdFieldList"></div>
                  <div class="modal-buttons" style="margin-top: 1rem;">
                     <button class="modal-button cancel-button" id="osdConfigClose">Close</button>
                     <button class="modal-button connect-button" id="osdConfigClear">Clear All</button>
                  </div>
               </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-container" id="chat-container">
               <h2 class="chat-title">AI Assistant</h2>
               <div class="chat-provider-row" id="chatProviderRow">
                  <select id="chatProviderSelect" class="chat-provider-select">
                     <option value="gemini">Gemini</option>
                     <option value="openai">OpenAI (GPT-4o)</option>
                     <option value="claude">Claude</option>
                  </select>
               </div>
               <div class="chat-messages" id="chatMessages">
               </div>
               <div class="chat-input">
                  <input type="text" class="chat-input-field" id="chatInput" placeholder="Ask a question about your drone...">
                  <button class="voice-button" id="voiceButton">
                     <i class="fas fa-microphone"></i>
                  </button>
                  <button class="send-button" id="sendButton">
                     <i class="fas fa-paper-plane"></i>
                  </button>
               </div>
               <div class="voice-status-indicator" id="voiceStatusIndicator"></div>
            </div>
         </div>
      </div>
      <!-- Connection Modal -->
      <div class="modal" id="connectionModal">
         <div class="modal-content">
            <div class="modal-title">Connect to Drone</div>
            <div class="form-group" style="display:flex;gap:1.5rem;align-items:center;">
               <label><input type="radio" name="connType" value="serial" checked onchange="toggleConnFields()"> Serial</label>
               <label><input type="radio" name="connType" value="ip" onchange="toggleConnFields()"> IP (UDP)</label>
            </div>
            <div id="serialFields">
               <div class="form-group">
                  <label for="portInput">Port:</label>
                  <input type="text" id="portInput" value="COM3" placeholder="COM3">
               </div>
               <div class="form-group">
                  <label for="baudInput">Baud Rate:</label>
                  <input type="text" id="baudInput" value="115200" placeholder="115200">
               </div>
            </div>
            <div id="ipFields" style="display:none;">
               <div class="form-group">
                  <label for="ipAddressInput">IP Address:</label>
                  <input type="text" id="ipAddressInput" value="0.0.0.0" placeholder="0.0.0.0">
               </div>
               <div class="form-group">
                  <label for="udpPortInput">Port:</label>
                  <input type="text" id="udpPortInput" value="14550" placeholder="14550">
               </div>
            </div>
            <div class="modal-buttons">
               <button class="modal-button cancel-button" id="cancelConnect">Cancel</button>
               <button class="modal-button connect-button" id="confirmConnect">Connect</button>
            </div>
         </div>
      </div>
      <!-- Scripts: core first, then tab modules -->
      <script defer src="/static/js/core.js"></script>
      <script defer src="/static/js/tabs/latency.js"></script>
      <script defer src="/static/js/tabs/motors.js"></script>
      <script defer src="/static/js/tabs/rc-modes.js"></script>
      <script defer src="/static/js/tabs/chat.js"></script>
      <script defer src="/static/js/tabs/parameters.js"></script>
      <script defer src="/static/js/tabs/configs.js"></script>
      <script defer src="/static/js/tabs/calibration.js"></script>
      <script defer src="/static/js/tabs/firmware.js"></script>
      <script defer src="/static/js/tabs/logs.js"></script>
      <script defer src="/static/js/tabs/serial-ports.js"></script>
      <script defer src="/static/js/tabs/drone-view.js"></script>
      <script defer src="/static/js/tabs/settings.js"></script>
   </body>
</html>
